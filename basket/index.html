<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Planet Fatness ‚Äî Streak Shot</title>
  <style>
    :root{
      --pf-purple:#6b2cff;
      --pf-yellow:#ffd400;
      --pf-ink:#0b0b12;
      --pf-muted: rgba(255,255,255,.72);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 900px at 50% 15%, rgba(107,44,255,.35), transparent 55%),
        radial-gradient(1000px 700px at 50% 90%, rgba(255,212,0,.18), transparent 55%),
        linear-gradient(180deg, var(--pf-ink), #05050c);
      color:#fff; overflow:hidden;
    }
    .wrap{
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      padding: calc(12px + var(--safe-top)) 12px calc(12px + var(--safe-bottom));
      gap:10px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,18,36,.55);
      backdrop-filter: blur(10px);
      border-radius:16px;
      box-shadow: 0 18px 48px rgba(0,0,0,.35);
    }
    .left,.right{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .brand{display:flex; flex-direction:column; line-height:1.05;}
    .brand .t1{font-weight:900; letter-spacing:.4px; font-size:14px;}
    .brand .t2{font-size:12px; color:var(--pf-muted); font-weight:700;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      font-weight:1000; font-size:12px; user-select:none;
    }
    .pill strong{color:var(--pf-yellow);}
    .btn{
      appearance:none; border:none;
      padding:10px 12px; border-radius:12px;
      font-weight:1100;
      background: linear-gradient(180deg, rgba(255,212,0,.95), rgba(255,170,0,.9));
      color:#1a1200;
      cursor:pointer;
      box-shadow: 0 0 18px rgba(255,212,0,.25), 0 0 32px rgba(107,44,255,.18);
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }
    .btn:active{transform: translateY(1px);}
    .hud{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:space-between;
    }
    .group{display:flex; gap:10px; flex-wrap:wrap;}
    .panel{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,18,36,.35);
      border-radius:16px;
      padding:10px 12px;
      display:flex; align-items:center; gap:10px;
      box-shadow: 0 18px 48px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      user-select:none;
      min-width:120px;
    }
    .label{font-size:11px; color:var(--pf-muted); font-weight:1000; letter-spacing:.35px;}
    .value{font-size:16px; font-weight:1200; letter-spacing:.2px;}
    .value span{color:var(--pf-yellow);}
    .canvasWrap{
      position:relative;
      flex:1;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(255,212,0,.09), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(107,44,255,.11), transparent 55%),
        rgba(0,0,0,.18);
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      touch-action:none;
    }
    canvas{display:block;width:100%;height:100%;}
    .toast{
      position:absolute; left:50%; bottom:14px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      font-weight:1100;
      font-size:12px;
      opacity:0;
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 18px rgba(255,212,0,.25), 0 0 32px rgba(107,44,255,.18);
      white-space:nowrap;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}
    .hint{
      position:absolute; left:12px; bottom:12px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.30);
      color: rgba(255,255,255,.78);
      font-weight:900;
      font-size:12px;
      backdrop-filter: blur(10px);
      user-select:none;
    }
    .overlay{
      position:absolute; inset:0;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(10px);
      padding:16px;
    }
    .overlay.show{display:flex;}
    .card{
      width:min(560px,100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(18,18,36,.55);
      box-shadow: 0 28px 90px rgba(0,0,0,.6);
      padding:16px;
    }
    .card h2{margin:0 0 6px;font-size:18px;font-weight:1200;}
    .card p{margin:0 0 12px;color:var(--pf-muted);font-weight:900;font-size:13px;line-height:1.35;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .divider{height:1px;background: rgba(255,255,255,.10);margin:12px 0;}
    .leader{
      max-height: 220px; overflow:auto;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:10px;
    }
    .leader table{width:100%;border-collapse:collapse;font-size:13px;}
    .leader th,.leader td{padding:8px 6px;text-align:left;border-bottom:1px solid rgba(255,255,255,.08);}
    .leader th{color:var(--pf-muted);font-size:11px;letter-spacing:.35px;}
    .mini{display:flex; gap:10px; flex-wrap:wrap;}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="left">
      <div class="brand">
        <div class="t1">PLANET FATNESS</div>
        <div class="t2">Streak Shot</div>
      </div>
      <div class="pill">STREAK <strong id="streakTxt">0</strong></div>
      <div class="pill">SCORE <strong id="scoreTxt">0</strong></div>
      <div class="pill">RUN BEST <strong id="runBestTxt">0</strong></div>
    </div>
    <div class="right">
      <button class="btn secondary" id="btnMain">‚Üê Main</button>
      <button class="btn secondary" id="btnBoard">Leaderboard</button>
      <button class="btn" id="btnStart">Start</button>
    </div>
  </header>

  <div class="hud">
    <div class="group">
      <div class="panel"><div><div class="label">ACTIVE FOOD</div><div class="value" id="foodTxt">‚Äî</div></div></div>
      <div class="panel"><div><div class="label">MULTI</div><div class="value"><span id="multiTxt">1√ó</span></div></div></div>
    </div>
    <div class="group">
      <div class="panel"><div><div class="label">MOUTH</div><div class="value"><span id="rimTxt">MOVING</span></div></div></div>
      <div class="panel"><div><div class="label">RULE</div><div class="value"><span>Miss = End</span></div></div></div>
    </div>
  </div>

  <div class="canvasWrap" id="stage">
    <canvas id="cv"></canvas>
    <div class="toast" id="toast"></div>
    <div class="hint">Drag toward target to aim ‚Ä¢ Release to shoot ‚Ä¢ Line shows ascent only ‚Ä¢ Miss ends run</div>

    <!-- Start -->
    <div class="overlay show" id="overlayStart">
      <div class="card">
        <h2>One miss ends the run.</h2>
        <p>Chase the highest streak. Golden donuts are double. After a miss, you can save + share your run.</p>
        <div class="row">
          <button class="btn" id="btnGo" style="flex:1;">Run It</button>
          <button class="btn secondary" id="btnCloseStart" style="flex:1;">Not Yet</button>
        </div>
      </div>
    </div>

    <!-- End -->
    <div class="overlay" id="overlayEnd">
      <div class="card">
        <h2>Run over.</h2>
        <p id="endLine">Save it or run it back.</p>

        <div class="mini">
          <div class="panel" style="flex:1;"><div><div class="label">FINAL STREAK</div><div class="value"><span id="finalStreakTxt">0</span></div></div></div>
          <div class="panel" style="flex:1;"><div><div class="label">FINAL SCORE</div><div class="value"><span id="finalScoreTxt">0</span></div></div></div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn" id="btnSave" style="flex:1;">Save to Leaderboard</button>
          <button class="btn secondary" id="btnShare" style="flex:1;">Share</button>
        </div>

        <div class="divider"></div>

        <div class="leader" id="leaderBoxEnd"></div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn" id="btnAgain" style="flex:1;">Run It Back</button>
          <button class="btn secondary" id="btnCloseEnd" style="flex:1;">Close</button>
        </div>
      </div>
    </div>

    <!-- Board -->
    <div class="overlay" id="overlayBoard">
      <div class="card">
        <h2>Leaderboard</h2>
        <p>Local device leaderboard (best streak first, then score).</p>
        <div class="leader" id="leaderBox"></div>
        <div class="divider"></div>
        <div class="row">
          <button class="btn secondary" id="btnResetLB" style="flex:1;">Reset Local Board</button>
          <button class="btn" id="btnCloseBoard" style="flex:1;">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp=(a,b,t)=>a+(b-a)*t;

  const stage=document.getElementById('stage');
  const cv=document.getElementById('cv');
  const ctx=cv.getContext('2d');

  const streakTxt=document.getElementById('streakTxt');
  const scoreTxt=document.getElementById('scoreTxt');
  const runBestTxt=document.getElementById('runBestTxt');
  const foodTxt=document.getElementById('foodTxt');
  const multiTxt=document.getElementById('multiTxt');
  const rimTxt=document.getElementById('rimTxt');
  const toast=document.getElementById('toast');

  const overlayStart=document.getElementById('overlayStart');
  const overlayEnd=document.getElementById('overlayEnd');
  const overlayBoard=document.getElementById('overlayBoard');

  const finalStreakTxt=document.getElementById('finalStreakTxt');
  const finalScoreTxt=document.getElementById('finalScoreTxt');
  const endLine=document.getElementById('endLine');

  const leaderBox=document.getElementById('leaderBox');
  const leaderBoxEnd=document.getElementById('leaderBoxEnd');

  const btnStart=document.getElementById('btnStart');
  const btnGo=document.getElementById('btnGo');
  const btnCloseStart=document.getElementById('btnCloseStart');
  const btnBoard=document.getElementById('btnBoard');
  const btnCloseBoard=document.getElementById('btnCloseBoard');
  const btnResetLB=document.getElementById('btnResetLB');
  const btnMain=document.getElementById('btnMain');

  const btnAgain=document.getElementById('btnAgain');
  const btnCloseEnd=document.getElementById('btnCloseEnd');
  const btnSave=document.getElementById('btnSave');
  const btnShare=document.getElementById('btnShare');

  function resize(){
    const r=stage.getBoundingClientRect();
    const dpr=Math.max(1, Math.min(2, window.devicePixelRatio||1));
    cv.width=Math.floor(r.width*dpr);
    cv.height=Math.floor(r.height*dpr);
    cv.style.width=r.width+'px';
    cv.style.height=r.height+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  const W=()=>stage.getBoundingClientRect().width;
  const H=()=>stage.getBoundingClientRect().height;

  // ---- image loader (safe) ----
  const IMG = {};
  function loadImage(key, src){
    return new Promise(res=>{
      const im=new Image();
      im.onload=()=>{ IMG[key]=im; res(true); };
      im.onerror=()=>{ console.warn('Missing image:', src); IMG[key]=null; res(false); };
      im.src=src;
    });
  }
  const ASSET_PROMISE = Promise.all([
    loadImage('MOUTH', 'assets/targets/mouth_idle.png'),
    loadImage('DONUT', 'assets/foods/food_donut.png'),
    loadImage('GOLD',  'assets/foods/food_donut_gold.png'),
    loadImage('COOKIE','assets/foods/food_cookie.png'),
    loadImage('MEAT',  'assets/foods/food_meatball.png'),
    loadImage('PIZZA', 'assets/foods/food_pizza.png'),
  ]);

  // ---- leaderboard ----
  const LB_KEY='pf_basket_streakshot_v2';
  const loadLB=()=>{try{return JSON.parse(localStorage.getItem(LB_KEY)||'[]');}catch{return[];}};
  const saveLB=(rows)=>localStorage.setItem(LB_KEY,JSON.stringify(rows));
  function addLB(streak, score){
    const rows=loadLB();
    rows.push({streak, score, at:Date.now()});
    rows.sort((a,b)=> (b.streak-a.streak) || (b.score-a.score));
    saveLB(rows.slice(0,30));
  }
  function renderLB(el){
    const rows=loadLB();
    if(!rows.length){
      el.innerHTML='<div style="color:rgba(255,255,255,.7);font-weight:1000;">No runs yet.</div>';
      return;
    }
    const fmt=(ts)=>{const d=new Date(ts);return d.toLocaleDateString(undefined,{month:'short',day:'numeric'})+' '+d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});};
    let html='<table><thead><tr><th>#</th><th>Streak</th><th>Score</th><th>When</th></tr></thead><tbody>';
    rows.forEach((r,i)=>{
      html+=`<tr>
        <td>${i+1}</td>
        <td style="font-weight:1200;color:rgba(255,212,0,.95)">${r.streak}</td>
        <td>${r.score}</td>
        <td style="color:rgba(255,255,255,.65)">${fmt(r.at)}</td>
      </tr>`;
    });
    html+='</tbody></table>';
    el.innerHTML=html;
  }

  // ---- toast ----
  let toastT=0;
  const showToast=(msg)=>{toast.textContent=msg;toast.classList.add('show');toastT=1.1;};

  // ---- food (physics + sprite key) ----
  const FOOD = {
    COOKIE:   { label:'üç™ Cookie',    g:1.02, drag:0.989, sprite:'COOKIE', r:18 },
    DONUT:    { label:'üç© Donut',     g:0.90, drag:0.978, sprite:'DONUT',  r:18 },
    MEATBALL: { label:'üçñ Meatball',  g:1.12, drag:0.992, sprite:'MEAT',   r:18 },
    PIZZA:    { label:'üçï Deep Dish', g:1.06, drag:0.986, sprite:'PIZZA',  r:19 },
    GOLD:     { label:'‚≠ê Golden',     g:0.96, drag:0.980, sprite:'GOLD',   r:18, golden:true }
  };
  function pickFood(){
    if(Math.random()<0.10) return 'GOLD';
    const r=Math.random();
    if(r<0.35) return 'COOKIE';
    if(r<0.68) return 'DONUT';
    if(r<0.86) return 'MEATBALL';
    return 'PIZZA';
  }

  // ---- layout ----
  function layout(){
    const w=W(), h=H();
    const shooter = { x: w*0.16, y: h*0.78 };
    const mouthR  = Math.max(42, w*0.072);
    return { w,h, shooter, mouthR };
  }

  // Better stations: all reachable + more ‚Äúaround‚Äù the top-middle zone
  function mouthStations(L){
    const w=L.w, h=L.h;
    return [
      {x:w*0.50, y:h*0.18},
      {x:w*0.64, y:h*0.22},
      {x:w*0.36, y:h*0.22},
      {x:w*0.72, y:h*0.30},
      {x:w*0.28, y:h*0.30},
      {x:w*0.60, y:h*0.36},
      {x:w*0.40, y:h*0.36},
    ];
  }

  // ---- state ----
  let run=null;
  let lastRun=null;

  function newRun(){
    const L=layout();
    const stations=mouthStations(L);
    const first=stations[Math.floor(Math.random()*stations.length)];
    return {
      playing:true,
      ended:false,
      saved:false,
      streak:0,
      score:0,
      runBest:0,
      aiming:false,
      aimNow:{x:0,y:0},
      foodKey: pickFood(),
      ball:null,
      mouth:{ x:first.x, y:first.y, tx:first.x, ty:first.y, t:1, moving:true },
      anim:{ glow:0, chomp:0, annoyed:0 },
    };
  }

  function updateHUD(){
    streakTxt.textContent=String(run.streak);
    scoreTxt.textContent=String(run.score);
    runBestTxt.textContent=String(run.runBest);
    const f=FOOD[run.foodKey];
    foodTxt.textContent=f.label;
    multiTxt.textContent = f.golden ? '2√ó' : '1√ó';
    rimTxt.textContent = run.mouth.moving ? 'MOVING' : 'FIXED';
  }

  function start(){
    run=newRun();
    lastRun=null;
    overlayEnd.classList.remove('show');
    updateHUD();
    showToast('Lock in. One miss ends it.');
  }

  function moveMouth(){
    const L=layout();
    const stations=mouthStations(L);
    let pick=stations[Math.floor(Math.random()*stations.length)];
    let tries=0;
    while(tries++<8 && Math.hypot(pick.x-run.mouth.tx, pick.y-run.mouth.ty) < L.w*0.10){
      pick=stations[Math.floor(Math.random()*stations.length)];
    }
    run.mouth.tx=pick.x;
    run.mouth.ty=pick.y;
    run.mouth.t=0;
  }

  function setupNextShot(){
    run.foodKey=pickFood();
    run.ball=null;
    if(run.mouth.moving) moveMouth();
    updateHUD();
  }

  function endRun(reason){
    if(!run || run.ended) return;
    run.ended=true;
    run.playing=false;

    lastRun = { streak: run.streak, score: run.score, at: Date.now(), reason: reason||'MISS' };

    finalStreakTxt.textContent = String(lastRun.streak);
    finalScoreTxt.textContent = String(lastRun.score);
    endLine.textContent = (reason==='MISS') ? 'Missed. Run ended.' : 'Run ended.';

    renderLB(leaderBoxEnd);
    overlayEnd.classList.add('show');
  }

  function miss(){
    showToast('Miss.');
    run.anim.annoyed=0.35;
    endRun('MISS');
  }

  function make(){
    const f=FOOD[run.foodKey];
    const pts=f.golden?2:1;

    run.score += pts;
    run.streak += 1;
    run.runBest = Math.max(run.runBest, run.streak);

    run.anim.chomp=0.18;
    run.anim.glow=0.60;

    showToast(f.golden ? `GOLDEN +2 (Streak ${run.streak})` : `+1 (Streak ${run.streak})`);
    setupNextShot();
  }

  // ---- input ----
  function canAim(){ return run && run.playing && !run.ended && !run.ball; }
  function getPos(e){
    const rect=stage.getBoundingClientRect();
    const t=e.touches && e.touches[0];
    const cx=t? t.clientX : e.clientX;
    const cy=t? t.clientY : e.clientY;
    return {x: cx-rect.left, y: cy-rect.top};
  }
  function onDown(e){
    if(!canAim()) return;
    e.preventDefault();
    run.aiming=true;
    run.aimNow=getPos(e);
  }
  function onMove(e){
    if(!run || !run.aiming) return;
    e.preventDefault();
    run.aimNow=getPos(e);
  }
  function onUp(e){
    if(!run || !run.aiming) return;
    e.preventDefault();
    run.aiming=false;
    shootTowardPointer();
  }

  stage.addEventListener('mousedown', onDown);
  stage.addEventListener('mousemove', onMove);
  stage.addEventListener('mouseup', onUp);
  stage.addEventListener('mouseleave', ()=>{ if(run) run.aiming=false; });

  stage.addEventListener('touchstart', onDown, {passive:false});
  stage.addEventListener('touchmove', onMove, {passive:false});
  stage.addEventListener('touchend', onUp, {passive:false});
  stage.addEventListener('touchcancel', ()=>{ if(run) run.aiming=false; }, {passive:true});

  // NEW: intuitive aiming ‚Äî drag TOWARD the direction you want to shoot
  function shootTowardPointer(){
    const L=layout();
    const s=L.shooter;
    const a=run.aimNow;

    let dx=a.x - s.x;
    let dy=a.y - s.y;

    // If user drags downward (dy positive), clamp a bit so it still shoots up-ish
    dy = Math.min(dy, -20);

    const dist=Math.hypot(dx,dy);
    const maxPull=Math.max(220, L.w*0.40);
    const pull=clamp(dist, 0, maxPull);
    const power=pull/maxPull;

    const nx=dx/(dist||1);
    const ny=dy/(dist||1);

    // More reach + nice curve
    const speed=lerp(820, 2050, power*power);

    const key=run.foodKey;
    const f=FOOD[key];

    run.ball={
      x:s.x, y:s.y,
      vx:nx*speed,
      vy:ny*speed,
      r:f.r,
      key,
      life:0
    };
  }

  // ---- sim + draw ----
  function step(dt){
    if(!run) return;

    if(toastT>0){ toastT-=dt; if(toastT<=0) toast.classList.remove('show'); }

    run.anim.chomp=Math.max(0,run.anim.chomp-dt);
    run.anim.annoyed=Math.max(0,run.anim.annoyed-dt);
    run.anim.glow=Math.max(0,run.anim.glow-dt);

    if(run.mouth.t<1){
      run.mouth.t=Math.min(1, run.mouth.t + dt*5.4);
      const t=1-Math.pow(1-run.mouth.t,3);
      run.mouth.x=lerp(run.mouth.x, run.mouth.tx, t);
      run.mouth.y=lerp(run.mouth.y, run.mouth.ty, t);
    } else {
      run.mouth.x=run.mouth.tx; run.mouth.y=run.mouth.ty;
    }

    if(run.ball){
      const L=layout();
      const b=run.ball;
      const f=FOOD[b.key];

      const g=980*f.g;

      b.vx*=f.drag;
      b.vy*=f.drag;
      b.vy+=g*dt;
      b.x+=b.vx*dt;
      b.y+=b.vy*dt;
      b.life+=dt;

      const dx=b.x-run.mouth.x, dy=b.y-run.mouth.y;
      const d=Math.hypot(dx,dy);

      // Target zones (mouth is hero)
      const clean=L.mouthR*0.55;
      const rattle=L.mouthR*0.92;

      // Only allow "make" when ball is descending and roughly centered vertically
      if(b.vy>0 && dy>-40 && dy<140){
        if(d<=clean){ make(); return; }
        if(d<=rattle){
          let chance=0.55 + (b.key==='PIZZA'?0.10:0) + (b.key==='GOLD'?0.06:0);
          chance=clamp(chance,0.35,0.88);
          if(Math.random()<chance) make();
          else miss();
          return;
        }
      }

      const margin=110;
      if(b.x<-margin || b.x>L.w+margin || b.y<-margin || b.y>L.h+margin || b.life>4.4){
        miss(); return;
      }
    }
  }

  function drawSprite(imgKey, x, y, size, rot=0, alpha=1){
    const im = IMG[imgKey];
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(rot);
    ctx.globalAlpha = alpha;

    // soft shadow for arcade pop
    ctx.shadowColor = 'rgba(0,0,0,0.45)';
    ctx.shadowBlur = 14;
    ctx.shadowOffsetY = 6;

    if(im){
      ctx.drawImage(im, -size/2, -size/2, size, size);
    } else {
      // safe fallback if missing asset
      ctx.shadowBlur=0;
      ctx.fillStyle='rgba(255,255,255,0.10)';
      ctx.beginPath(); ctx.arc(0,0,size*0.45,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='rgba(255,255,255,0.30)';
      ctx.lineWidth=2; ctx.stroke();
    }
    ctx.restore();
  }

  function draw(){
    const L=layout();
    ctx.clearRect(0,0,L.w,L.h);

    // subtle court curve
    ctx.save();
    ctx.globalAlpha=0.14;
    ctx.lineWidth=2;
    ctx.strokeStyle='rgba(255,255,255,0.14)';
    ctx.beginPath();
    ctx.arc(L.w*0.50, L.h*0.10, Math.min(L.w*0.68, L.h*0.68), 0.08*Math.PI, 0.92*Math.PI);
    ctx.stroke();
    ctx.restore();

    // shooter marker
    const s=L.shooter;
    ctx.save();
    ctx.globalAlpha=0.85;
    ctx.fillStyle='rgba(255,255,255,0.08)';
    ctx.beginPath();
    ctx.roundRect(s.x-18, s.y-48, 36, 58, 12);
    ctx.fill();

    ctx.fillStyle='rgba(255,212,0,0.85)';
    ctx.beginPath();
    ctx.arc(s.x, s.y-58, 14, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    // mouth target (image)
    const tWig = run.anim.annoyed>0 ? Math.sin((1-run.anim.annoyed)*18)*3 : 0;
    const glow = run.anim.glow;

    if(glow>0){
      ctx.save();
      ctx.globalAlpha = 0.16 + glow*0.25;
      ctx.fillStyle='rgba(255,212,0,0.75)';
      ctx.beginPath();
      ctx.arc(run.mouth.x+tWig, run.mouth.y, L.mouthR*1.35, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    // draw mouth sprite bigger than hit radius
    drawSprite('MOUTH', run.mouth.x+tWig, run.mouth.y, L.mouthR*2.45, 0, 1);

    // Aim preview: ASCENT ONLY (stop at apex)
    if(run.aiming && !run.ball && run.playing && !run.ended){
      const a=run.aimNow;
      let dx=a.x - s.x;
      let dy=a.y - s.y;
      dy = Math.min(dy, -20);

      const dist=Math.hypot(dx,dy);
      const maxPull=Math.max(220, L.w*0.40);
      const pull=clamp(dist,0,maxPull);
      const power=pull/maxPull;

      const nx=dx/(dist||1), ny=dy/(dist||1);
      const speed=lerp(820, 2050, power*power);

      const key=run.foodKey;
      const f=FOOD[key];

      let vx=nx*speed, vy=ny*speed;
      let x=s.x, y=s.y;

      const g=980*f.g;
      const simDt=1/60;

      ctx.save();
      ctx.fillStyle='rgba(255,255,255,0.78)';

      for(let i=0;i<34;i++){
        // stop once we hit the apex (vy flips to positive)
        if(vy >= 0) break;

        ctx.globalAlpha=0.85*(1-i/36);
        ctx.beginPath();
        ctx.arc(x,y,i===0?3.2:2.3,0,Math.PI*2);
        ctx.fill();

        vx*=f.drag; vy*=f.drag;
        vy+=g*simDt;
        x+=vx*simDt; y+=vy*simDt;
      }
      ctx.restore();
    }

    // ball sprite
    if(run.ball){
      const b=run.ball;
      const f=FOOD[b.key];

      // gentle spin based on velocity
      const rot = Math.atan2(b.vy, b.vx) * 0.15;

      // draw sprite size tied to radius
      const size = b.r * 2.4;
      drawSprite(f.sprite, b.x, b.y, size, rot, 1);
    }
  }

  let last=performance.now();
  function loop(now){
    requestAnimationFrame(loop);
    const dt=Math.min(0.033,(now-last)/1000);
    last=now;

    if(run){
      if(run.playing && !run.ended) step(dt);
      draw();
    } else {
      // idle
      const tmp=newRun();
      tmp.playing=false;
      run=tmp; draw(); run=null;
    }
  }

  // ---- share + save ----
  async function shareRun(){
    if(!lastRun) return;
    const text = `Planet Fatness ‚Äî Basket Streak Shot\nüî• Streak: ${lastRun.streak}\nüç© Score: ${lastRun.score}\nCan you beat it?`;
    const url = location.href;

    if(navigator.share){
      try{ await navigator.share({ title:'Planet Fatness ‚Äî Basket Streak Shot', text, url }); }
      catch(e){}
    } else {
      try{
        await navigator.clipboard.writeText(text + `\n` + url);
        showToast('Copied share text.');
      } catch(e){
        showToast('Share not supported here.');
      }
    }
  }

  function saveRun(){
    if(!lastRun) return;
    if(run && run.saved) return;
    addLB(lastRun.streak, lastRun.score);
    if(run) run.saved=true;
    renderLB(leaderBoxEnd);
    showToast('Saved to leaderboard.');
  }

  // ---- overlays / buttons ----
  btnStart.onclick=()=>overlayStart.classList.add('show');
  btnGo.onclick=async ()=>{
    overlayStart.classList.remove('show');
    await ASSET_PROMISE; // let images start loading
    start();
  };
  btnCloseStart.onclick=()=>overlayStart.classList.remove('show');

  btnBoard.onclick=()=>{overlayBoard.classList.add('show'); renderLB(leaderBox);};
  btnCloseBoard.onclick=()=>overlayBoard.classList.remove('show');
  btnResetLB.onclick=()=>{saveLB([]); renderLB(leaderBox); showToast('Local leaderboard reset.');};

  btnAgain.onclick=()=>{overlayEnd.classList.remove('show'); start();};
  btnCloseEnd.onclick=()=>overlayEnd.classList.remove('show');

  btnSave.onclick=saveRun;
  btnShare.onclick=shareRun;

  // main path
  btnMain.onclick=()=>{ window.location.href='/'; };

  requestAnimationFrame(loop);

})();
</script>
</body>
</html>