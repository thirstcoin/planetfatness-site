<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Planet Fatness ‚Äî Streak Shot</title>
  <style>
    :root{
      --pf-purple:#6b2cff;
      --pf-yellow:#ffd400;
      --pf-ink:#0b0b12;
      --pf-muted: rgba(255,255,255,.72);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 900px at 50% 15%, rgba(107,44,255,.35), transparent 55%),
        radial-gradient(1000px 700px at 50% 90%, rgba(255,212,0,.18), transparent 55%),
        linear-gradient(180deg, var(--pf-ink), #05050c);
      color:#fff; overflow:hidden;
    }
    .wrap{
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      padding: calc(12px + var(--safe-top)) 12px calc(12px + var(--safe-bottom));
      gap:10px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,18,36,.55);
      backdrop-filter: blur(10px);
      border-radius:16px;
      box-shadow: 0 18px 48px rgba(0,0,0,.35);
      z-index: 10;
    }
    .left,.right{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .brand{display:flex; flex-direction:column; line-height:1.05;}
    .brand .t1{font-weight:900; letter-spacing:.4px; font-size:14px;}
    .brand .t2{font-size:12px; color:var(--pf-muted); font-weight:700;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      font-weight:1000; font-size:12px; user-select:none;
    }
    .pill strong{color:var(--pf-yellow);}
    .btn{
      appearance:none; border:none;
      padding:10px 12px; border-radius:12px;
      font-weight:1100;
      background: linear-gradient(180deg, rgba(255,212,0,.95), rgba(255,170,0,.9));
      color:#1a1200;
      cursor:pointer;
      box-shadow: 0 0 18px rgba(255,212,0,.25), 0 0 32px rgba(107,44,255,.18);
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }
    .btn:active{transform: translateY(1px);}
    .hud{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:space-between;
      z-index: 10;
    }
    .group{display:flex; gap:10px; flex-wrap:wrap;}
    .panel{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,18,36,.35);
      border-radius:16px;
      padding:10px 12px;
      display:flex; align-items:center; gap:10px;
      box-shadow: 0 18px 48px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      user-select:none;
      min-width:120px;
    }
    .label{font-size:11px; color:var(--pf-muted); font-weight:1000; letter-spacing:.35px;}
    .value{font-size:16px; font-weight:1200; letter-spacing:.2px;}
    .value span{color:var(--pf-yellow);}

    .canvasWrap{
      position:relative;
      flex:1;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(255,212,0,.09), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(107,44,255,.11), transparent 55%),
        rgba(0,0,0,.18);
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
    }

    /* ‚úÖ VIDEO BACKGROUND (behind canvas) */
    .arenaVideo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:0;
      /* tiny boost so it pops under overlays */
      filter: saturate(1.05) contrast(1.03);
      transform: translateZ(0);
    }
    .arenaVignette{
      position:absolute;
      inset:0;
      z-index:0;
      pointer-events:none;
      background:
        radial-gradient(1200px 700px at 50% 10%, rgba(255,212,0,.10), transparent 55%),
        radial-gradient(1200px 700px at 50% 100%, rgba(107,44,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.42));
      mix-blend-mode: multiply;
    }

    /* ‚úÖ keep canvas above the video */
    canvas{
      position:relative;
      z-index:1;
      display:block;
      width:100%;
      height:100%;
    }

    /* ‚úÖ overlays + UI above everything */
    .toast, .hint, .overlay{ z-index:2; }

    .toast{
      position:absolute; left:50%; bottom:14px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      font-weight:1100;
      font-size:12px;
      opacity:0;
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 18px rgba(255,212,0,.25), 0 0 32px rgba(107,44,255,.18);
      white-space:nowrap;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}
    .hint{
      position:absolute; left:12px; bottom:12px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.30);
      color: rgba(255,255,255,.78);
      font-weight:900;
      font-size:12px;
      backdrop-filter: blur(10px);
      user-select:none;
    }
    .overlay{
      position:absolute; inset:0;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(10px);
      padding:16px;
    }
    .overlay.show{display:flex;}
    .card{
      width:min(560px,100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(18,18,36,.55);
      box-shadow: 0 28px 90px rgba(0,0,0,.6);
      padding:16px;
    }
    .card h2{margin:0 0 6px;font-size:18px;font-weight:1200;}
    .card p{margin:0 0 12px;color:var(--pf-muted);font-weight:900;font-size:13px;line-height:1.35;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .divider{height:1px;background: rgba(255,255,255,.10);margin:12px 0;}
    .leader{
      max-height: 220px; overflow:auto;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:10px;
    }
    .leader table{width:100%;border-collapse:collapse;font-size:13px;}
    .leader th,.leader td{padding:8px 6px;text-align:left;border-bottom:1px solid rgba(255,255,255,.08);}
    .leader th{color:var(--pf-muted);font-size:11px;letter-spacing:.35px;}
    .mini{display:flex; gap:10px; flex-wrap:wrap;}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="left">
      <div class="brand">
        <div class="t1">PLANET FATNESS</div>
        <div class="t2">Streak Shot</div>
      </div>
      <div class="pill">STREAK <strong id="streakTxt">0</strong></div>
      <div class="pill">SCORE <strong id="scoreTxt">0</strong></div>
      <div class="pill">RUN BEST <strong id="runBestTxt">0</strong></div>
    </div>
    <div class="right">
      <button class="btn secondary" id="btnMain">‚Üê Main</button>
      <button class="btn secondary" id="btnBoard">Leaderboard</button>
      <button class="btn" id="btnStart">Start</button>
    </div>
  </header>

  <div class="hud">
    <div class="group">
      <div class="panel"><div><div class="label">ACTIVE FOOD</div><div class="value" id="foodTxt">‚Äî</div></div></div>
      <div class="panel"><div><div class="label">MULTI</div><div class="value"><span id="multiTxt">1√ó</span></div></div></div>
    </div>
    <div class="group">
      <div class="panel"><div><div class="label">RIM</div><div class="value"><span id="rimTxt">MOVING</span></div></div></div>
      <div class="panel"><div><div class="label">RULE</div><div class="value"><span>Miss = End</span></div></div></div>
    </div>
  </div>

  <div class="canvasWrap" id="stage">
    <!-- ‚úÖ NEW: CROWD VIDEO BACKGROUND -->
    <video
      class="arenaVideo"
      id="arenaVid"
      autoplay
      muted
      loop
      playsinline
      preload="auto"
      poster="/assets/streakshot_bg_gym.png"
    >
      <source src="/assets/arena-crowd-loop.mp4" type="video/mp4" />
    </video>
    <div class="arenaVignette"></div>

    <canvas id="cv"></canvas>
    <div class="toast" id="toast"></div>
    <div class="hint">Drag from the food in his hands ‚Ä¢ Release to shoot ‚Ä¢ Miss ends run ‚Ä¢ Golden = 2√ó</div>

    <div class="overlay show" id="overlayStart">
      <div class="card">
        <h2>One miss ends the run.</h2>
        <p>Chase the highest streak. Golden donuts are double. After a miss, you can save + share your run.</p>
        <div class="row">
          <button class="btn" id="btnGo" style="flex:1;">Run It</button>
          <button class="btn secondary" id="btnCloseStart" style="flex:1;">Not Yet</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="overlayEnd">
      <div class="card">
        <h2>Run over.</h2>
        <p id="endLine">Save it or run it back.</p>

        <div class="mini">
          <div class="panel" style="flex:1;"><div><div class="label">FINAL STREAK</div><div class="value"><span id="finalStreakTxt">0</span></div></div></div>
          <div class="panel" style="flex:1;"><div><div class="label">FINAL SCORE</div><div class="value"><span id="finalScoreTxt">0</span></div></div></div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn" id="btnSave" style="flex:1;">Save to Leaderboard</button>
          <button class="btn secondary" id="btnShare" style="flex:1;">Share</button>
        </div>

        <div class="divider"></div>

        <div class="leader" id="leaderBoxEnd"></div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn" id="btnAgain" style="flex:1;">Run It Back</button>
          <button class="btn secondary" id="btnCloseEnd" style="flex:1;">Close</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="overlayBoard">
      <div class="card">
        <h2>Leaderboard</h2>
        <p>Local device leaderboard (best streak first, then score).</p>
        <div class="leader" id="leaderBox"></div>
        <div class="divider"></div>
        <div class="row">
          <button class="btn secondary" id="btnResetLB" style="flex:1;">Reset Local Board</button>
          <button class="btn" id="btnCloseBoard" style="flex:1;">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp=(a,b,t)=>a+(b-a)*t;

  const stage=document.getElementById('stage');
  const cv=document.getElementById('cv');
  const ctx=cv.getContext('2d');

  // ‚úÖ ensure iOS actually plays the background video
  const arenaVid = document.getElementById('arenaVid');
  if (arenaVid){
    const tryPlay = async () => { try { await arenaVid.play(); } catch(e){} };
    document.addEventListener('touchstart', tryPlay, { once:true, passive:true });
    document.addEventListener('click', tryPlay, { once:true, passive:true });
    tryPlay();
  }

  const streakTxt=document.getElementById('streakTxt');
  const scoreTxt=document.getElementById('scoreTxt');
  const runBestTxt=document.getElementById('runBestTxt');
  const foodTxt=document.getElementById('foodTxt');
  const multiTxt=document.getElementById('multiTxt');
  const rimTxt=document.getElementById('rimTxt');

  const toast=document.getElementById('toast');

  const overlayStart=document.getElementById('overlayStart');
  const overlayEnd=document.getElementById('overlayEnd');
  const overlayBoard=document.getElementById('overlayBoard');

  const finalStreakTxt=document.getElementById('finalStreakTxt');
  const finalScoreTxt=document.getElementById('finalScoreTxt');
  const endLine=document.getElementById('endLine');

  const leaderBox=document.getElementById('leaderBox');
  const leaderBoxEnd=document.getElementById('leaderBoxEnd');

  const btnStart=document.getElementById('btnStart');
  const btnGo=document.getElementById('btnGo');
  const btnCloseStart=document.getElementById('btnCloseStart');
  const btnBoard=document.getElementById('btnBoard');
  const btnCloseBoard=document.getElementById('btnCloseBoard');
  const btnResetLB=document.getElementById('btnResetLB');
  const btnMain=document.getElementById('btnMain');

  const btnAgain=document.getElementById('btnAgain');
  const btnCloseEnd=document.getElementById('btnCloseEnd');
  const btnSave=document.getElementById('btnSave');
  const btnShare=document.getElementById('btnShare');

  function resize(){
    const r=stage.getBoundingClientRect();
    const dpr=Math.max(1, Math.min(2, window.devicePixelRatio||1));
    cv.width=Math.floor(r.width*dpr);
    cv.height=Math.floor(r.height*dpr);
    cv.style.width=r.width+'px';
    cv.style.height=r.height+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  const W=()=>stage.getBoundingClientRect().width;
  const H=()=>stage.getBoundingClientRect().height;

  // ---- leaderboard ----
  const LB_KEY='pf_streakshot_miss_ends_v1';
  const loadLB=()=>{try{return JSON.parse(localStorage.getItem(LB_KEY)||'[]');}catch{return[];}};
  const saveLB=(rows)=>localStorage.setItem(LB_KEY,JSON.stringify(rows));

  function addLB(streak, score){
    const rows=loadLB();
    rows.push({streak, score, at:Date.now()});
    rows.sort((a,b)=> (b.streak-a.streak) || (b.score-a.score));
    saveLB(rows.slice(0,30));
  }

  function renderLB(el){
    const rows=loadLB();
    if(!rows.length){
      el.innerHTML='<div style="color:rgba(255,255,255,.7);font-weight:1000;">No runs yet.</div>';
      return;
    }
    const fmt=(ts)=>{const d=new Date(ts);return d.toLocaleDateString(undefined,{month:'short',day:'numeric'})+' '+d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});};
    let html='<table><thead><tr><th>#</th><th>Streak</th><th>Score</th><th>When</th></tr></thead><tbody>';
    rows.forEach((r,i)=>{
      html+=`<tr>
        <td>${i+1}</td>
        <td style="font-weight:1200;color:rgba(255,212,0,.95)">${r.streak}</td>
        <td>${r.score}</td>
        <td style="color:rgba(255,255,255,.65)">${fmt(r.at)}</td>
      </tr>`;
    });
    html+='</tbody></table>';
    el.innerHTML=html;
  }

  // ---- toast ----
  let toastT=0;
  const showToast=(msg)=>{toast.textContent=msg;toast.classList.add('show');toastT=1.1;};

  // ---- asset loader ----
  function loadImage(src){
    return new Promise((resolve,reject)=>{
      const img=new Image();
      img.onload=()=>resolve(img);
      img.onerror=()=>reject(new Error('Failed to load '+src));
      img.src=src;
    });
  }

  const ASSET_PATH = '/assets/';
  const ASSETS = {
    basket: ASSET_PATH + 'basket_mouth.png',
    player: ASSET_PATH + 'basket_player_idle.png',
    cookie: ASSET_PATH + 'food_cookie_ball.png',
    donut:  ASSET_PATH + 'food_donut_pink_ball.png',
    meat:   ASSET_PATH + 'food_meatball_ball.png',
    pizza:  ASSET_PATH + 'food_pizza_deepdish_ball.png',
    gold:   ASSET_PATH + 'food_donut_gold_ball.png',
  };

  const IMG = { ready:false };

  async function preload(){
    try{
      const [basket,player,cookie,donut,meat,pizza,gold] = await Promise.all([
        loadImage(ASSETS.basket),
        loadImage(ASSETS.player),
        loadImage(ASSETS.cookie),
        loadImage(ASSETS.donut),
        loadImage(ASSETS.meat),
        loadImage(ASSETS.pizza),
        loadImage(ASSETS.gold),
      ]);
      IMG.basket=basket;
      IMG.player=player;
      IMG.cookie=cookie;
      IMG.donut=donut;
      IMG.meat=meat;
      IMG.pizza=pizza;
      IMG.gold=gold;
      IMG.ready=true;
      showToast('Assets loaded.');
    }catch(e){
      console.log(e);
      showToast('Missing PNGs ‚Äî check /assets filenames.');
    }
  }
  preload();

  // ---- food ----
  const FOOD = {
    COOKIE:   { label:'üç™ Cookie',    g:1.02, drag:0.989, r:18, imgKey:'cookie' },
    DONUT:    { label:'üç© Donut',     g:0.90, drag:0.978, r:18, imgKey:'donut'  },
    MEATBALL: { label:'üçñ Meatball',  g:1.12, drag:0.992, r:18, imgKey:'meat'   },
    PIZZA:    { label:'üçï Deep Dish', g:1.06, drag:0.986, r:19, imgKey:'pizza'  },
    GOLD:     { label:'‚≠ê Golden',     g:0.96, drag:0.980, r:18, imgKey:'gold', golden:true }
  };
  function pickFood(){
    if(Math.random()<0.10) return 'GOLD';
    const r=Math.random();
    if(r<0.35) return 'COOKIE';
    if(r<0.68) return 'DONUT';
    if(r<0.86) return 'MEATBALL';
    return 'PIZZA';
  }

  // ---- layout ----
  const HAND_OX = -17;
  const HAND_OY = -39;

  function layout(){
    const w=W(), h=H();
    const playerBase = { x: w*0.06, y: h*0.93 };
    const playerH = Math.max(160, h*0.30);

    const hand = {
      x: playerBase.x + playerH*0.78 + HAND_OX,
      y: playerBase.y - playerH*0.72 + HAND_OY
    };

    const rimR = Math.max(34, w*0.055);
    return { w,h, playerBase, playerH, hand, rimR };
  }

  function rimStations(L){
    const w=L.w, h=L.h;
    return [
      {x:w*0.62, y:h*0.22},
      {x:w*0.78, y:h*0.30},
      {x:w*0.54, y:h*0.30},
      {x:w*0.70, y:h*0.40},
      {x:w*0.86, y:h*0.44},
      {x:w*0.58, y:h*0.42},
    ];
  }

  // ---- state ----
  let run=null;
  let lastRun=null;

  function newRun(){
    const L=layout();
    const stations=rimStations(L);
    const first=stations[Math.floor(Math.random()*stations.length)];
    return {
      playing:true,
      ended:false,
      saved:false,

      streak:0,
      score:0,
      runBest:0,

      aiming:false,
      aimNow:{x:0,y:0},

      foodKey: pickFood(),
      ball:null,

      rim:{ x:first.x, y:first.y, tx:first.x, ty:first.y, t:1 },
      rimMoving:true,
    };
  }

  function updateHUD(){
    streakTxt.textContent=String(run.streak);
    scoreTxt.textContent=String(run.score);
    runBestTxt.textContent=String(run.runBest);
    const f=FOOD[run.foodKey];
    foodTxt.textContent=f.label;
    multiTxt.textContent = f.golden ? '2√ó' : '1√ó';
    rimTxt.textContent = run.rimMoving ? 'MOVING' : 'FIXED';
  }

  function start(){
    run=newRun();
    lastRun=null;
    overlayEnd.classList.remove('show');
    updateHUD();
    showToast('Lock in. One miss ends it.');
  }

  function moveRim(){
    const L=layout();
    const stations=rimStations(L);
    let pick=stations[Math.floor(Math.random()*stations.length)];
    let tries=0;
    while(tries++<6 && Math.hypot(pick.x-run.rim.tx, pick.y-run.rim.ty) < L.w*0.08){
      pick=stations[Math.floor(Math.random()*stations.length)];
    }
    run.rim.tx=pick.x;
    run.rim.ty=pick.y;
    run.rim.t=0;
  }

  function setupNextShot(){
    run.foodKey=pickFood();
    run.ball=null;
    if(run.rimMoving) moveRim();
    updateHUD();
  }

  function endRun(reason){
    if(!run || run.ended) return;
    run.ended=true;
    run.playing=false;

    lastRun = { streak: run.streak, score: run.score, at: Date.now(), reason: reason||'MISS' };

    finalStreakTxt.textContent = String(lastRun.streak);
    finalScoreTxt.textContent = String(lastRun.score);
    endLine.textContent = (reason==='MISS') ? 'Missed. Run ended.' : 'Run ended.';

    renderLB(leaderBoxEnd);
    overlayEnd.classList.add('show');
  }

  function miss(){
    showToast('Miss.');
    endRun('MISS');
  }

  function make(){
    const f=FOOD[run.foodKey];
    const pts=f.golden?2:1;

    run.score += pts;
    run.streak += 1;
    run.runBest = Math.max(run.runBest, run.streak);

    showToast(f.golden ? `GOLDEN +2 (Streak ${run.streak})` : `+1 (Streak ${run.streak})`);
    setupNextShot();
  }

  // shared power model
  function computeShotSpeed(L, s, a){
    const dx=s.x-a.x;
    const dy=s.y-a.y;
    const dist=Math.hypot(dx,dy);

    const maxPull=Math.max(200, L.w*0.36);
    const pull=clamp(dist,0,maxPull);

    let power=pull/maxPull;
    power = Math.pow(power, 1.35);

    const rimDist = Math.hypot(run.rim.x - s.x, run.rim.y - s.y);
    const closeFactor = clamp(rimDist / Math.max(220, L.w*0.55), 0.55, 1.0);

    const minSpeed = 240;
    const maxSpeed = 1650 * closeFactor;

    const speed = lerp(minSpeed, maxSpeed, power);
    return { dx, dy, dist, speed };
  }

  // ---- input ----
  function canAim(){ return run && run.playing && !run.ended && !run.ball; }
  function getPos(e){
    const rect=stage.getBoundingClientRect();
    const t=e.touches && e.touches[0];
    const cx=t? t.clientX : e.clientX;
    const cy=t? t.clientY : e.clientY;
    return {x: cx-rect.left, y: cy-rect.top};
  }

  function isNearHeldFood(p){
    const L=layout();
    const hx=L.hand.x, hy=L.hand.y;
    const d=Math.hypot(p.x-hx, p.y-hy);
    return d < Math.max(46, L.w*0.07);
  }

  function onDown(e){
    if(!canAim()) return;
    e.preventDefault();
    const p=getPos(e);
    if(!isNearHeldFood(p)) return;
    run.aiming=true;
    run.aimNow=p;
  }
  function onMove(e){
    if(!run || !run.aiming) return;
    e.preventDefault();
    run.aimNow=getPos(e);
  }
  function onUp(e){
    if(!run || !run.aiming) return;
    e.preventDefault();
    run.aiming=false;
    shoot();
  }
  stage.addEventListener('mousedown', onDown);
  stage.addEventListener('mousemove', onMove);
  stage.addEventListener('mouseup', onUp);
  stage.addEventListener('mouseleave', ()=>{ if(run) run.aiming=false; });

  stage.addEventListener('touchstart', onDown, {passive:false});
  stage.addEventListener('touchmove', onMove, {passive:false});
  stage.addEventListener('touchend', onUp, {passive:false});
  stage.addEventListener('touchcancel', ()=>{ if(run) run.aiming=false; }, {passive:true});

  function shoot(){
    const L=layout();
    const s=L.hand;
    const a=run.aimNow;

    const { dx, dy, dist, speed } = computeShotSpeed(L, s, a);

    const nx=dx/(dist||1);
    const ny=dy/(dist||1);

    const key=run.foodKey;
    const f=FOOD[key];

    run.ball={
      x:s.x, y:s.y,
      px:s.x, py:s.y,
      vx:nx*speed,
      vy:ny*speed,
      r:f.r,
      key,
      life:0,
      enteredRimZone:false,
      floorBounced:false
    };
  }

  // ---- sim + draw ----
  function step(dt){
    if(!run) return;

    if(toastT>0){ toastT-=dt; if(toastT<=0) toast.classList.remove('show'); }

    if(run.rim.t<1){
      run.rim.t=Math.min(1, run.rim.t + dt*6.0);
      const t=1-Math.pow(1-run.rim.t,3);
      run.rim.x=lerp(run.rim.x, run.rim.tx, t);
      run.rim.y=lerp(run.rim.y, run.rim.ty, t);
    } else {
      run.rim.x=run.rim.tx; run.rim.y=run.rim.ty;
    }

    if(!run.ball) return;

    const L=layout();
    const b=run.ball;
    const f=FOOD[b.key];

    const g=980*f.g;

    b.px=b.x; b.py=b.y;

    b.vx*=f.drag;
    b.vy*=f.drag;
    b.vy+=g*dt;
    b.x+=b.vx*dt;
    b.y+=b.vy*dt;
    b.life+=dt;

    const mouthY = run.rim.y + (L.rimR*0.10);
    const mouthHalfW = L.rimR*0.72;

    const zonePad = L.rimR*1.05;
    if(Math.abs(b.x-run.rim.x) < zonePad && Math.abs(b.y-mouthY) < zonePad) b.enteredRimZone = true;

    const crossed = (b.py < mouthY && b.y >= mouthY);
    if(b.vy>0 && crossed){
      const t = (mouthY - b.py) / ((b.y - b.py) || 1);
      const xAt = b.px + (b.x - b.px) * t;
      if(Math.abs(xAt - run.rim.x) <= mouthHalfW){
        make(); return;
      }
    }

    const floorY = L.h * 0.78;
    if(!b.floorBounced && b.vy>0 && (b.y + b.r) >= floorY){
      b.floorBounced = true;
      b.y = floorY - b.r;

      b.vy *= -0.42;
      b.vx *= 0.78;

      if(Math.abs(b.vy) < 140){
        miss(); return;
      }
    }

    const margin=180;
    const maxLife=6.0;

    const offScreen = (b.x < -margin || b.x > L.w + margin || b.y < -margin || b.y > L.h + margin);
    const timedOut  = (b.life > maxLife);

    const fellBelowRim = (b.y > run.rim.y + L.rimR*2.6 && b.vy > 0);

    if(offScreen || timedOut){
      if(b.enteredRimZone){
        if(fellBelowRim || b.y > L.h + margin){
          miss(); return;
        }
      } else {
        miss(); return;
      }
    }

    if(b.floorBounced && b.vy>0 && (b.y > floorY + 40)){
      miss(); return;
    }
  }

  function drawImageCentered(img, x, y, size){
    if(!img) return;
    const w=img.naturalWidth||img.width;
    const h=img.naturalHeight||img.height;
    const scale = size / Math.max(w,h);
    const dw = w * scale;
    const dh = h * scale;
    ctx.drawImage(img, x - dw/2, y - dh/2, dw, dh);
  }

  function drawPlayer(L){
    if(!IMG.ready || !IMG.player) return;

    const img=IMG.player;
    const iw=img.naturalWidth||img.width;
    const ih=img.naturalHeight||img.height;

    const scale = L.playerH / ih;
    const dw = iw * scale;
    const dh = ih * scale;

    ctx.drawImage(img, L.playerBase.x, L.playerBase.y - dh, dw, dh);
  }

  function drawHeldFood(L){
    if(!run) return;
    if(run.ball) return;

    const f=FOOD[run.foodKey];
    if(IMG.ready){
      const img = IMG[f.imgKey];
      const size = (f.r * 4.8);
      drawImageCentered(img, L.hand.x, L.hand.y, size);
    }
  }

  function draw(){
    const L=layout();
    ctx.clearRect(0,0,L.w,L.h);

    // court hint
    ctx.save();
    ctx.globalAlpha=0.18;
    ctx.lineWidth=2;
    ctx.strokeStyle='rgba(255,255,255,0.14)';
    ctx.beginPath();
    ctx.arc(L.w*0.72, L.h*0.18, Math.min(L.w*0.52, L.h*0.52), 0.15*Math.PI, 0.85*Math.PI);
    ctx.stroke();
    ctx.restore();

    drawPlayer(L);
    drawHeldFood(L);

    if(IMG.ready && IMG.basket){
      const bx = run.rim.x;
      const by = run.rim.y - (L.rimR*0.35);
      const size = L.rimR * 4.2;
      drawImageCentered(IMG.basket, bx, by, size);
    } else {
      ctx.save();
      ctx.translate(run.rim.x, run.rim.y);
      ctx.fillStyle='rgba(107,44,255,0.68)';
      ctx.beginPath(); ctx.arc(0,0,L.rimR,0,Math.PI*2); ctx.fill();
      ctx.lineWidth=4; ctx.strokeStyle='rgba(255,212,0,0.80)'; ctx.stroke();
      ctx.fillStyle='rgba(0,0,0,0.55)';
      ctx.beginPath(); ctx.ellipse(0,L.rimR*0.10,L.rimR*0.72,L.rimR*0.42,0,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }

    if(run.aiming && !run.ball && run.playing && !run.ended){
      const s=L.hand;
      const a=run.aimNow;

      const { dx, dy, dist, speed } = computeShotSpeed(L, s, a);
      const nx=dx/(dist||1), ny=dy/(dist||1);

      const key=run.foodKey;
      const f=FOOD[key];

      let vx=nx*speed, vy=ny*speed;
      let x=s.x, y=s.y;

      const g=980*f.g;
      const simDt=1/60;

      ctx.save();
      ctx.fillStyle='rgba(255,255,255,0.70)';
      for(let i=0;i<28;i++){
        ctx.globalAlpha=0.80*(1-i/30);
        ctx.beginPath();
        ctx.arc(x,y,i===0?3:2.2,0,Math.PI*2);
        ctx.fill();
        vx*=f.drag; vy*=f.drag;
        vy+=g*simDt;
        x+=vx*simDt; y+=vy*simDt;
      }
      ctx.restore();
    }

    if(run.ball){
      const b=run.ball;
      const f=FOOD[b.key];

      if(IMG.ready){
        const img = IMG[f.imgKey];
        const size = b.r * 4.8;
        drawImageCentered(img, b.x, b.y, size);
      } else {
        ctx.save();
        ctx.translate(b.x,b.y);
        ctx.beginPath();
        ctx.fillStyle='rgba(255,255,255,0.85)';
        ctx.arc(0,0,b.r,0,Math.PI*2);
        ctx.fill();
        ctx.restore();
      }
    }
  }

  let last=performance.now();
  function loop(now){
    requestAnimationFrame(loop);
    const dt=Math.min(0.033,(now-last)/1000);
    last=now;

    if(run){
      if(run.playing && !run.ended) step(dt);
      draw();
    } else {
      const tmp=newRun();
      tmp.playing=false;
      run=tmp; draw(); run=null;
    }
  }
  requestAnimationFrame(loop);

  // ---- share + save ----
  async function shareRun(){
    if(!lastRun) return;
    const text = `Planet Fatness ‚Äî Streak Shot\nüî• Streak: ${lastRun.streak}\nüç© Score: ${lastRun.score}\nCan you beat it?`;
    const url = location.href;

    if(navigator.share){
      try{ await navigator.share({ title:'Planet Fatness ‚Äî Streak Shot', text, url }); }
      catch(e){}
    } else {
      try{
        await navigator.clipboard.writeText(text + `\n` + url);
        showToast('Copied share text.');
      } catch(e){
        showToast('Share not supported here.');
      }
    }
  }

  function saveRun(){
    if(!lastRun) return;
    if(run && run.saved) return;
    addLB(lastRun.streak, lastRun.score);
    if(run) run.saved=true;
    renderLB(leaderBoxEnd);
    showToast('Saved to leaderboard.');
  }

  // ---- overlays / buttons ----
  btnStart.onclick=()=>overlayStart.classList.add('show');
  btnGo.onclick=()=>{overlayStart.classList.remove('show'); start();};
  btnCloseStart.onclick=()=>overlayStart.classList.remove('show');

  btnBoard.onclick=()=>{overlayBoard.classList.add('show'); renderLB(leaderBox);};
  btnCloseBoard.onclick=()=>overlayBoard.classList.remove('show');
  btnResetLB.onclick=()=>{saveLB([]); renderLB(leaderBox); showToast('Local leaderboard reset.');};

  btnAgain.onclick=()=>{overlayEnd.classList.remove('show'); start();};
  btnCloseEnd.onclick=()=>overlayEnd.classList.remove('show');

  btnSave.onclick=saveRun;
  btnShare.onclick=shareRun;

  btnMain.onclick=()=>{ window.location.href='/'; };

})();
</script>
</body>
</html>