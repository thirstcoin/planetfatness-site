<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Planet Fatness ‚Äî Streak Shot</title>
  <style>
    :root{
      --pf-purple:#6b2cff;
      --pf-yellow:#ffd400;
      --pf-ink:#0b0b12;
      --pf-muted: rgba(255,255,255,.72);
      --pf-dim: rgba(255,255,255,.45);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 900px at 50% 15%, rgba(107,44,255,.35), transparent 55%),
        radial-gradient(1000px 700px at 50% 90%, rgba(255,212,0,.18), transparent 55%),
        linear-gradient(180deg, var(--pf-ink), #05050c);
      color:#fff; overflow:hidden;
    }
    .wrap{
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      padding: calc(12px + var(--safe-top)) 12px calc(12px + var(--safe-bottom));
      gap:10px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,18,36,.55);
      backdrop-filter: blur(10px);
      border-radius:16px;
      box-shadow: 0 18px 48px rgba(0,0,0,.35);
    }
    .left,.right{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .brand{display:flex; flex-direction:column; line-height:1.05;}
    .brand .t1{font-weight:900; letter-spacing:.4px; font-size:14px;}
    .brand .t2{font-size:12px; color:var(--pf-muted); font-weight:700;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      font-weight:1000; font-size:12px; user-select:none;
    }
    .pill strong{color:var(--pf-yellow);}
    .btn{
      appearance:none; border:none;
      padding:10px 12px; border-radius:12px;
      font-weight:1100;
      background: linear-gradient(180deg, rgba(255,212,0,.95), rgba(255,170,0,.9));
      color:#1a1200;
      cursor:pointer;
      box-shadow: 0 0 18px rgba(255,212,0,.25), 0 0 32px rgba(107,44,255,.18);
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }
    .btn:active{transform: translateY(1px);}
    .hud{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:space-between;
    }
    .group{display:flex; gap:10px; flex-wrap:wrap;}
    .panel{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,18,36,.35);
      border-radius:16px;
      padding:10px 12px;
      display:flex; align-items:center; gap:10px;
      box-shadow: 0 18px 48px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      user-select:none;
      min-width:120px;
    }
    .label{font-size:11px; color:var(--pf-muted); font-weight:1000; letter-spacing:.35px;}
    .value{font-size:16px; font-weight:1200; letter-spacing:.2px;}
    .value span{color:var(--pf-yellow);}
    .canvasWrap{
      position:relative;
      flex:1;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(255,212,0,.09), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(107,44,255,.11), transparent 55%),
        rgba(0,0,0,.18);
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
    }
    canvas{display:block;width:100%;height:100%;}
    .toast{
      position:absolute; left:50%; bottom:14px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      font-weight:1100;
      font-size:12px;
      opacity:0;
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 18px rgba(255,212,0,.25), 0 0 32px rgba(107,44,255,.18);
      white-space:nowrap;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}
    .overlay{
      position:absolute; inset:0;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(10px);
      padding:16px;
    }
    .overlay.show{display:flex;}
    .card{
      width:min(560px,100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(18,18,36,.55);
      box-shadow: 0 28px 90px rgba(0,0,0,.6);
      padding:16px;
    }
    .card h2{margin:0 0 6px;font-size:18px;font-weight:1200;}
    .card p{margin:0 0 12px;color:var(--pf-muted);font-weight:900;font-size:13px;line-height:1.35;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .divider{height:1px;background: rgba(255,255,255,.10);margin:12px 0;}
    .leader{
      max-height: 200px; overflow:auto;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:10px;
    }
    .leader table{width:100%;border-collapse:collapse;font-size:13px;}
    .leader th,.leader td{padding:8px 6px;text-align:left;border-bottom:1px solid rgba(255,255,255,.08);}
    .leader th{color:var(--pf-muted);font-size:11px;letter-spacing:.35px;}
    .hint{
      position:absolute; left:12px; bottom:12px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.30);
      color: rgba(255,255,255,.78);
      font-weight:900;
      font-size:12px;
      backdrop-filter: blur(10px);
      user-select:none;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="left">
      <div class="brand">
        <div class="t1">PLANET FATNESS</div>
        <div class="t2">Streak Shot</div>
      </div>
      <div class="pill">STREAK <strong id="streakTxt">0</strong></div>
      <div class="pill">BEST <strong id="bestTxt">0</strong></div>
      <div class="pill">SCORE <strong id="scoreTxt">0</strong></div>
    </div>
    <div class="right">
      <button class="btn secondary" id="btnMain">‚Üê Main</button>
      <button class="btn secondary" id="btnBoard">Leaderboard</button>
      <button class="btn" id="btnStart">Start</button>
    </div>
  </header>

  <div class="hud">
    <div class="group">
      <div class="panel"><div><div class="label">ACTIVE FOOD</div><div class="value" id="foodTxt">‚Äî</div></div></div>
      <div class="panel"><div><div class="label">MULTI</div><div class="value"><span id="multiTxt">1√ó</span></div></div></div>
    </div>
    <div class="group">
      <div class="panel"><div><div class="label">MOVING RIM</div><div class="value"><span id="rimTxt">ON</span></div></div></div>
      <div class="panel"><div><div class="label">MODE</div><div class="value"><span>Endless</span></div></div></div>
    </div>
  </div>

  <div class="canvasWrap" id="stage">
    <canvas id="cv"></canvas>
    <div class="toast" id="toast"></div>
    <div class="hint">Drag to aim + power ‚Ä¢ Release to shoot ‚Ä¢ Golden donut = 2√ó</div>

    <div class="overlay show" id="overlayStart">
      <div class="card">
        <h2>One shooter. Rim moves every shot.</h2>
        <p>Chase the <b>highest streak</b>. Golden donuts are worth <b>double</b>. Miss resets streak but you can grind for a legendary run.</p>
        <div class="row">
          <button class="btn" id="btnGo" style="flex:1;">Run It</button>
          <button class="btn secondary" id="btnCloseStart" style="flex:1;">Not Yet</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="overlayBoard">
      <div class="card">
        <h2>Leaderboard</h2>
        <p>Local device leaderboard (best streak + best score).</p>
        <div class="leader" id="leaderBox"></div>
        <div class="divider"></div>
        <div class="row">
          <button class="btn secondary" id="btnResetLB" style="flex:1;">Reset Local Board</button>
          <button class="btn" id="btnCloseBoard" style="flex:1;">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp=(a,b,t)=>a+(b-a)*t;
  const rnd=(a,b)=>a+Math.random()*(b-a);

  const stage=document.getElementById('stage');
  const cv=document.getElementById('cv');
  const ctx=cv.getContext('2d');

  const streakTxt=document.getElementById('streakTxt');
  const bestTxt=document.getElementById('bestTxt');
  const scoreTxt=document.getElementById('scoreTxt');
  const foodTxt=document.getElementById('foodTxt');
  const multiTxt=document.getElementById('multiTxt');
  const rimTxt=document.getElementById('rimTxt');

  const toast=document.getElementById('toast');

  const overlayStart=document.getElementById('overlayStart');
  const overlayBoard=document.getElementById('overlayBoard');
  const leaderBox=document.getElementById('leaderBox');

  const btnStart=document.getElementById('btnStart');
  const btnGo=document.getElementById('btnGo');
  const btnCloseStart=document.getElementById('btnCloseStart');
  const btnBoard=document.getElementById('btnBoard');
  const btnCloseBoard=document.getElementById('btnCloseBoard');
  const btnResetLB=document.getElementById('btnResetLB');
  const btnMain=document.getElementById('btnMain');

  function resize(){
    const r=stage.getBoundingClientRect();
    const dpr=Math.max(1, Math.min(2, window.devicePixelRatio||1));
    cv.width=Math.floor(r.width*dpr);
    cv.height=Math.floor(r.height*dpr);
    cv.style.width=r.width+'px';
    cv.style.height=r.height+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  const W=()=>stage.getBoundingClientRect().width;
  const H=()=>stage.getBoundingClientRect().height;

  // ---- leaderboard (local) ----
  const LB_KEY='pf_streakshot_lb_v1';
  const loadLB=()=>{try{return JSON.parse(localStorage.getItem(LB_KEY)||'[]');}catch{return[];}};
  const saveLB=(rows)=>localStorage.setItem(LB_KEY,JSON.stringify(rows));
  function addLB(bestStreak, bestScore){
    const rows=loadLB();
    rows.push({bestStreak, bestScore, at:Date.now()});
    rows.sort((a,b)=> (b.bestStreak-a.bestStreak) || (b.bestScore-a.bestScore));
    saveLB(rows.slice(0,25));
  }
  function renderLB(){
    const rows=loadLB();
    if(!rows.length){
      leaderBox.innerHTML='<div style="color:rgba(255,255,255,.7);font-weight:1000;">No runs yet.</div>';
      return;
    }
    const fmt=(ts)=>{const d=new Date(ts);return d.toLocaleDateString(undefined,{month:'short',day:'numeric'})+' '+d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});};
    let html='<table><thead><tr><th>#</th><th>Best Streak</th><th>Best Score</th><th>When</th></tr></thead><tbody>';
    rows.forEach((r,i)=>{
      html+=`<tr>
        <td>${i+1}</td>
        <td style="font-weight:1200;color:rgba(255,212,0,.95)">${r.bestStreak}</td>
        <td>${r.bestScore}</td>
        <td style="color:rgba(255,255,255,.65)">${fmt(r.at)}</td>
      </tr>`;
    });
    html+='</tbody></table>';
    leaderBox.innerHTML=html;
  }

  // ---- toast ----
  let toastT=0;
  const showToast=(msg)=>{toast.textContent=msg;toast.classList.add('show');toastT=1.25;};

  // ---- food ----
  const FOOD = {
    COOKIE:   { label:'üç™ Cookie',    g:1.02, drag:0.989, r:14, color:'#ffd9a6' },
    DONUT:    { label:'üç© Donut',     g:0.90, drag:0.978, r:14, color:'#ff9adf' },
    MEATBALL: { label:'üçñ Meatball',  g:1.12, drag:0.992, r:14, color:'#b54a3a' },
    PIZZA:    { label:'üçï Deep Dish', g:1.06, drag:0.986, r:15, color:'#ffcc66' },
    GOLD:     { label:'‚≠ê Golden',     g:0.96, drag:0.980, r:14, color:'#ffd400', golden:true }
  };

  function pickFood(){
    // ~10% golden
    const t=Math.random();
    if(t<0.10) return 'GOLD';
    const r=Math.random();
    if(r<0.35) return 'COOKIE';
    if(r<0.68) return 'DONUT';
    if(r<0.86) return 'MEATBALL';
    return 'PIZZA';
  }

  // ---- layout ----
  function layout(){
    const w=W(), h=H();
    const shooter = { x: w*0.16, y: h*0.78 };
    const rimR = Math.max(30, w*0.05);
    return { w,h, shooter, rimR };
  }

  // rim ‚Äústations‚Äù (moves each shot)
  function rimStations(L){
    const w=L.w, h=L.h;
    return [
      {x:w*0.62, y:h*0.22},
      {x:w*0.78, y:h*0.30},
      {x:w*0.54, y:h*0.30},
      {x:w*0.70, y:h*0.40},
      {x:w*0.86, y:h*0.44},
      {x:w*0.58, y:h*0.42},
    ];
  }

  // ---- state ----
  let run=null;

  function newRun(){
    const L=layout();
    const stations=rimStations(L);
    const first=stations[Math.floor(Math.random()*stations.length)];
    return {
      playing:true,
      streak:0,
      bestStreak:0,
      score:0,
      bestScore:0,

      aiming:false,
      aimNow:{x:0,y:0},

      foodKey: pickFood(),
      ball:null,

      rim:{ x:first.x, y:first.y, tx:first.x, ty:first.y, t:1 },
      rimMoving:true,

      mouth:{chomp:0, annoyed:0, glow:0},
      seed: Math.floor(Math.random()*1e9)
    };
  }

  function start(){
    run=newRun();
    updateHUD();
    showToast('Lock in. Chase the streak.');
  }

  function updateHUD(){
    streakTxt.textContent=String(run.streak);
    bestTxt.textContent=String(run.bestStreak);
    scoreTxt.textContent=String(run.score);
    const f=FOOD[run.foodKey];
    foodTxt.textContent=f.label;
    multiTxt.textContent = f.golden ? '2√ó' : '1√ó';
    rimTxt.textContent = run.rimMoving ? 'ON' : 'OFF';
  }

  function moveRim(){
    const L=layout();
    const stations=rimStations(L);
    // pick a different station than current target
    let pick=stations[Math.floor(Math.random()*stations.length)];
    let tries=0;
    while(tries++<6 && Math.hypot(pick.x-run.rim.tx, pick.y-run.rim.ty) < L.w*0.08){
      pick=stations[Math.floor(Math.random()*stations.length)];
    }
    run.rim.tx=pick.x;
    run.rim.ty=pick.y;
    run.rim.t=0; // tween start
  }

  function nextShotSetup(){
    run.foodKey = pickFood();
    run.ball = null;
    if(run.rimMoving) moveRim();
    updateHUD();
  }

  function miss(){
    run.streak=0;
    run.mouth.annoyed=0.22;
    showToast('Miss. Streak reset.');
    nextShotSetup();
  }

  function make(isGolden){
    const pts = isGolden ? 2 : 1;
    run.score += pts;
    run.streak += 1;
    run.bestStreak = Math.max(run.bestStreak, run.streak);
    run.bestScore = Math.max(run.bestScore, run.score);

    run.mouth.chomp=0.22;
    run.mouth.glow=0.55;

    showToast(isGolden ? `GOLDEN +2 (Streak ${run.streak})` : `+1 (Streak ${run.streak})`);

    // save occasionally so ‚Äú50 in a row‚Äù feels recorded
    if(run.streak===10 || run.streak===25 || run.streak===50 || run.streak===75 || run.streak===100){
      addLB(run.bestStreak, run.bestScore);
    }

    nextShotSetup();
  }

  // ---- aiming + shooting ----
  function canAim(){ return run && run.playing && !run.ball; }

  function getPos(e){
    const rect=stage.getBoundingClientRect();
    const t=e.touches && e.touches[0];
    const cx=t? t.clientX : e.clientX;
    const cy=t? t.clientY : e.clientY;
    return {x: cx-rect.left, y: cy-rect.top};
  }

  function onDown(e){
    if(!canAim()) return;
    e.preventDefault();
    run.aiming=true;
    run.aimNow=getPos(e);
  }
  function onMove(e){
    if(!run || !run.aiming) return;
    e.preventDefault();
    run.aimNow=getPos(e);
  }
  function onUp(e){
    if(!run || !run.aiming) return;
    e.preventDefault();
    run.aiming=false;
    shoot();
  }

  stage.addEventListener('mousedown', onDown);
  stage.addEventListener('mousemove', onMove);
  stage.addEventListener('mouseup', onUp);
  stage.addEventListener('mouseleave', ()=>{ if(run) run.aiming=false; });

  stage.addEventListener('touchstart', onDown, {passive:false});
  stage.addEventListener('touchmove', onMove, {passive:false});
  stage.addEventListener('touchend', onUp, {passive:false});
  stage.addEventListener('touchcancel', ()=>{ if(run) run.aiming=false; }, {passive:true});

  function shoot(){
    const L=layout();
    const s=L.shooter;
    const a=run.aimNow;

    // vector from finger to shooter (pull back)
    const dx = s.x - a.x;
    const dy = s.y - a.y;
    const dist = Math.hypot(dx,dy);

    const maxPull = Math.max(200, L.w*0.36);
    const pull = clamp(dist, 0, maxPull);
    const power = pull / maxPull;

    const nx = dx / (dist||1);
    const ny = dy / (dist||1);

    // tuned for ‚Äúbasket boy‚Äù feel
    const speed = lerp(700, 1750, power*power);

    const key=run.foodKey;
    const f=FOOD[key];

    run.ball = {
      x:s.x, y:s.y,
      vx:nx*speed,
      vy:ny*speed,
      r:f.r,
      key,
      life:0
    };
  }

  // ---- sim ----
  function step(dt){
    if(!run) return;

    // toast
    if(toastT>0){ toastT-=dt; if(toastT<=0) toast.classList.remove('show'); }

    // mouth anim
    run.mouth.chomp=Math.max(0,run.mouth.chomp-dt);
    run.mouth.annoyed=Math.max(0,run.mouth.annoyed-dt);
    run.mouth.glow=Math.max(0,run.mouth.glow-dt);

    // rim tween
    if(run.rim.t < 1){
      // quick ease
      run.rim.t = Math.min(1, run.rim.t + dt*6.0);
      const t = 1 - Math.pow(1-run.rim.t, 3);
      run.rim.x = lerp(run.rim.x, run.rim.tx, t);
      run.rim.y = lerp(run.rim.y, run.rim.ty, t);
    } else {
      run.rim.x = run.rim.tx; run.rim.y = run.rim.ty;
    }

    if(run.ball){
      const L=layout();
      const b=run.ball;
      const f=FOOD[b.key];

      const g = 980 * f.g;

      b.vx *= f.drag;
      b.vy *= f.drag;

      b.vy += g*dt;
      b.x += b.vx*dt;
      b.y += b.vy*dt;
      b.life += dt;

      // collision check only on descent
      const dx=b.x-run.rim.x, dy=b.y-run.rim.y;
      const d=Math.hypot(dx,dy);

      const clean = L.rimR*0.55;
      const rattle = L.rimR*0.90;

      if(b.vy>0 && dy>-20 && dy<140){
        if(d <= clean){
          make(!!f.golden);
          return;
        } else if(d <= rattle){
          // rattle chance (pizza a bit sticky)
          let chance = 0.58 + (b.key==='PIZZA'?0.10:0) + (b.key==='GOLD'?0.06:0);
          chance = clamp(chance, 0.35, 0.88);
          if(Math.random()<chance) make(!!f.golden);
          else miss();
          return;
        }
      }

      // out of bounds
      const margin=90;
      if(b.x<-margin || b.x>L.w+margin || b.y<-margin || b.y>L.h+margin || b.life>4.2){
        miss(); return;
      }
    }
  }

  // ---- drawing ----
  function draw(){
    const L=layout();
    ctx.clearRect(0,0,L.w,L.h);

    // subtle court arc + dots
    ctx.save();
    ctx.globalAlpha=0.18;
    ctx.lineWidth=2;
    ctx.strokeStyle='rgba(255,255,255,0.14)';
    ctx.beginPath();
    ctx.arc(L.w*0.70, L.h*0.18, Math.min(L.w*0.52, L.h*0.52), 0.15*Math.PI, 0.85*Math.PI);
    ctx.stroke();
    ctx.globalAlpha=1;
    ctx.restore();

    // shooter ‚Äúcharacter‚Äù
    const s=L.shooter;
    ctx.save();
    // body
    ctx.globalAlpha=0.85;
    ctx.fillStyle='rgba(255,255,255,0.10)';
    ctx.beginPath();
    ctx.roundRect(s.x-18, s.y-48, 36, 58, 12);
    ctx.fill();
    // head
    ctx.fillStyle='rgba(255,212,0,0.85)';
    ctx.beginPath();
    ctx.arc(s.x, s.y-58, 14, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    // rim mouth
    const baseR=L.rimR;
    const breath=Math.sin((performance.now()/1000)*2.0)*0.03;
    const chomp=run?run.mouth.chomp:0;
    const annoyed=run?run.mouth.annoyed:0;
    const glow=run?run.mouth.glow:0;

    const wig = annoyed>0 ? Math.sin((1-annoyed)*22)*3 : 0;

    ctx.save();
    ctx.translate(run?run.rim.x + wig : L.w*0.70, run?run.rim.y : L.h*0.28);

    if(glow>0){
      ctx.globalAlpha=0.20 + glow*0.35;
      ctx.fillStyle='rgba(255,212,0,0.70)';
      ctx.beginPath();
      ctx.arc(0,0,baseR*1.6,0,Math.PI*2);
      ctx.fill();
      ctx.globalAlpha=1;
    }

    ctx.beginPath();
    ctx.fillStyle='rgba(107,44,255,0.68)';
    ctx.arc(0,0,baseR*(1+breath),0,Math.PI*2);
    ctx.fill();

    ctx.lineWidth=4;
    ctx.strokeStyle='rgba(255,212,0,0.80)';
    ctx.stroke();

    const open=lerp(0.52,0.30, clamp(chomp*4,0,1));
    ctx.fillStyle='rgba(0,0,0,0.55)';
    ctx.beginPath();
    ctx.ellipse(0,baseR*0.10,baseR*0.72,baseR*open,0,0,Math.PI*2);
    ctx.fill();

    const blink=annoyed>0?clamp(1-annoyed*6,0.2,1):1;
    ctx.fillStyle='rgba(255,255,255,0.85)';
    ctx.beginPath();
    ctx.ellipse(-baseR*0.28,-baseR*0.46,baseR*0.12,baseR*0.08*blink,0,0,Math.PI*2);
    ctx.ellipse( baseR*0.28,-baseR*0.46,baseR*0.12,baseR*0.08*blink,0,0,Math.PI*2);
    ctx.fill();

    ctx.restore();

    // aiming preview (dotted)
    if(run && run.aiming && !run.ball){
      const a=run.aimNow;
      const dx = s.x - a.x;
      const dy = s.y - a.y;
      const dist = Math.hypot(dx,dy);

      const maxPull = Math.max(200, L.w*0.36);
      const pull = clamp(dist, 0, maxPull);
      const power = pull/maxPull;

      const nx=dx/(dist||1);
      const ny=dy/(dist||1);

      const speed = lerp(700, 1750, power*power);
      const key=run.foodKey;
      const f=FOOD[key];
      let vx=nx*speed, vy=ny*speed;

      let x=s.x, y=s.y;
      const g=980*f.g;
      const simDt=1/60;

      ctx.save();
      ctx.fillStyle='rgba(255,255,255,0.70)';
      for(let i=0;i<28;i++){
        // small dotted points
        ctx.globalAlpha = 0.80 * (1 - i/30);
        ctx.beginPath();
        ctx.arc(x, y, i===0?3:2.2, 0, Math.PI*2);
        ctx.fill();

        vx*=f.drag; vy*=f.drag;
        vy+=g*simDt;
        x+=vx*simDt; y+=vy*simDt;
      }
      ctx.restore();

      // pull ring
      ctx.save();
      ctx.globalAlpha=0.40;
      ctx.strokeStyle='rgba(255,212,0,0.85)';
      ctx.lineWidth=3;
      ctx.beginPath();
      ctx.arc(s.x, s.y, 32 + power*22, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    // ball
    if(run && run.ball){
      const b=run.ball;
      const f=FOOD[b.key];
      ctx.save();
      ctx.translate(b.x,b.y);
      ctx.beginPath();
      ctx.fillStyle=f.color;
      ctx.arc(0,0,b.r,0,Math.PI*2);
      ctx.fill();
      ctx.globalAlpha=0.55;
      ctx.strokeStyle='rgba(255,255,255,0.55)';
      ctx.lineWidth=2;
      ctx.stroke();
      ctx.globalAlpha=1;

      ctx.font='1200 14px ui-sans-serif, system-ui';
      ctx.textAlign='center';
      ctx.textBaseline='middle';
      ctx.fillStyle='rgba(0,0,0,0.55)';
      const glyph=(b.key==='COOKIE')?'C':(b.key==='DONUT')?'D':(b.key==='MEATBALL')?'M':(b.key==='PIZZA')?'P':'G';
      ctx.fillText(glyph,0,1);
      ctx.restore();
    }
  }

  // loop
  let last=performance.now();
  function loop(now){
    requestAnimationFrame(loop);
    const dt=Math.min(0.033,(now-last)/1000);
    last=now;
    if(run){
      step(dt);
      draw();
    } else {
      // idle draw
      run = newRun();
      run.playing=false;
      draw();
      run = null;
    }
  }
  requestAnimationFrame(loop);

  // buttons
  btnStart.onclick=()=>overlayStart.classList.add('show');
  btnGo.onclick=()=>{overlayStart.classList.remove('show'); start();};
  btnCloseStart.onclick=()=>overlayStart.classList.remove('show');

  btnBoard.onclick=()=>{overlayBoard.classList.add('show'); renderLB();};
  btnCloseBoard.onclick=()=>overlayBoard.classList.remove('show');
  btnResetLB.onclick=()=>{saveLB([]); renderLB(); showToast('Local leaderboard reset.');};

  // change this if your main path differs
  btnMain.onclick=()=>{ window.location.href='/'; };

  // when leaving a run, save bests
  window.addEventListener('beforeunload', ()=>{
    if(run) addLB(run.bestStreak, run.bestScore);
  });

})();
</script>
</body>
</html>