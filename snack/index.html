<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>$PHAT â€” Conveyor Munch</title>

  <style>
    :root{
      --bg1:#2a1442;
      --bg2:#140a22;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --pill:rgba(0,0,0,.35);
      --good:#6dffb3;
      --bad:#ff6d8a;
      --accent:#ffd44d;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--txt);
      background:
        radial-gradient(1000px 700px at 50% 10%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 700px at 50% 60%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      display:flex;
      justify-content:center;
    }

    .wrap{ width:min(980px, 94vw); padding:18px 0 28px; }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .titleBox{
      flex:1;
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:20px;
      padding:14px 16px;
      backdrop-filter: blur(10px);
    }
    .titleLine{
      font-weight:800;
      letter-spacing:.3px;
      font-size:18px;
      opacity:.95;
      margin-bottom:6px;
    }
    .subLine{ color:var(--muted); font-size:14px; line-height:1.3; }

    .btn{
      border:0;
      background:var(--accent);
      color:#231400;
      font-weight:900;
      padding:12px 14px;
      border-radius:16px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      cursor:pointer;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }

    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin:12px 0 14px;
    }
    .stat{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px;
      backdrop-filter: blur(10px);
      min-height:86px;
    }
    .stat .k{ font-size:12px; letter-spacing:1.8px; font-weight:800; opacity:.75; }
    .stat .v{ font-size:34px; font-weight:900; margin-top:4px; line-height:1; }
    .stat .s{ margin-top:6px; color:var(--muted); font-size:13px; }

    .stageCard{
      position:relative;
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:14px;
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .stage{
      position:relative;
      width:100%;
      aspect-ratio: 9 / 12;
      border-radius:18px;
      background: radial-gradient(700px 500px at 50% 15%, rgba(255,255,255,.08), transparent 60%);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }

    /* Scene background image */
    .scene{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:2;
    }
    .scene img{
      width:100%;
      height:100%;
      object-fit:contain;
      object-position:center;
      user-select:none;
      -webkit-user-drag:none;
      display:block;
    }

    /* Thought bubble + label cluster (UP so it won't cover face) */
    .thoughtCluster{
      position:absolute;
      left:50%;
      top:6.5%;              /* higher */
      transform:translateX(-50%);
      z-index:6;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      pointer-events:none;
    }

    .targetName{
      background:var(--pill);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:10px 14px;
      font-weight:900;
      letter-spacing:3px;
      text-transform:uppercase;
      text-align:center;
      max-width:min(92vw, 560px);
      line-height:1.15;
      font-size:16px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      white-space:normal;       /* never cut off shakes */
      word-break:break-word;
    }

    .thought{
      position:relative;
      width:min(240px, 54vw);   /* slightly smaller */
      aspect-ratio: 4 / 3;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .thought img.bubble{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      user-select:none;
      -webkit-user-drag:none;
    }
    .thought img.food{
      position:relative;
      width:44%;
      height:44%;
      object-fit:contain;
      transform: translateY(-2%);
      user-select:none;
      -webkit-user-drag:none;
    }

    /* Belt items layer */
    .itemsLayer{
      position:absolute;
      inset:0;
      z-index:5;
    }

    .foodItem{
      position:absolute;
      width:92px;
      height:92px;
      display:flex;
      align-items:center;
      justify-content:center;
      will-change: transform;
      touch-action:none;
      user-select:none;
      -webkit-user-drag:none;
      z-index:7;
    }
    .foodItem img{
      width:100%;
      height:100%;
      object-fit:contain;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    /* Invisible mouth drop target */
    .mouthTarget{
      position:absolute;
      left:50%;
      top:43%;
      transform:translate(-50%,-50%);
      width:155px;
      height:120px;
      border-radius:999px;
      z-index:8;
      pointer-events:none;
      opacity:0;
      outline:2px dashed rgba(109,255,179,.75);
      outline-offset:6px;
    }
    .debugOn .mouthTarget{ opacity:.18; }

    .toast{
      position:absolute;
      left:50%;
      top:52%;
      transform:translate(-50%,-50%);
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      padding:10px 16px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      z-index:10;
      display:none;
    }
    .toast.good{ color:var(--good); }
    .toast.bad{ color:var(--bad); }

    .bottomRow{ display:flex; gap:12px; margin-top:12px; }
    .ghostBtn{
      flex:1;
      border:1px solid var(--stroke);
      background:var(--card2);
      color:var(--txt);
      padding:12px 14px;
      border-radius:16px;
      font-weight:800;
      cursor:pointer;
    }

    .how{
      margin-top:12px;
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px 16px;
      color:var(--muted);
      line-height:1.35;
    }
    .how b{ color:var(--txt); }

    @media (min-width:720px){
      .stage{ aspect-ratio: 16 / 15; }
      .foodItem{ width:96px; height:96px; }
      .thoughtCluster{ top:5.5%; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="titleBox">
        <div class="titleLine">$PHAT â€” Conveyor Munch</div>
        <div class="subLine">Drag the correct snack into his mouth. Miss = pain. Streak = glory.</div>
      </div>
      <button class="btn" id="btnReset">Run it back</button>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="k">RUN</div>
        <div class="v" id="runScore">0</div>
        <div class="s">Streak: <span id="streak">0</span> Â· Mult: <span id="mult">1.0x</span></div>
      </div>
      <div class="stat">
        <div class="k">BEST</div>
        <div class="v" id="bestScore">0</div>
        <div class="s">Daily best: <span id="dailyBest">0</span></div>
      </div>
      <div class="stat">
        <div class="k">DAILY GOAL</div>
        <div class="v"><span id="dailyNow">0</span> / 30</div>
        <div class="s">Resets in <span id="resetIn">--:--:--</span></div>
      </div>
    </div>

    <div class="stageCard">
      <div class="stage" id="stage">
        <div class="thoughtCluster">
          <div class="targetName" id="targetName">â€”</div>
          <div class="thought">
            <img class="bubble" src="../assets/thought-bubble.png" alt="thought bubble" />
            <img class="food" id="targetFoodImg" src="" alt="target food" />
          </div>
        </div>

        <div class="mouthTarget" id="mouthTarget"></div>
        <div class="itemsLayer" id="itemsLayer"></div>

        <div class="scene">
          <img id="sceneImg" src="../assets/stack_scene.png" alt="scene" />
        </div>

        <div class="toast" id="toast"></div>
      </div>

      <div class="bottomRow">
        <button class="ghostBtn" id="btnShare">Share score</button>
        <button class="ghostBtn" id="btnDebug">Toggle debug</button>
      </div>

      <div class="how">
        <b>How it plays:</b> The thought bubble shows what he wants. The belt feeds a nonstop stream of snacks.
        Grab the correct one <b>between the wrong choices</b> and drag it to his mouth before it rolls away.
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- ALL FOOD ASSETS ----------
  const FOODS = [
    { id:"brownies",      label:"Brownies",         src:"../assets/food_brownies.png" },
    { id:"burger",        label:"Burger",           src:"../assets/food_burger.png" },
    { id:"cake",          label:"Cake",             src:"../assets/food_cake.png" },
    { id:"takeout",       label:"Chinese Takeout",  src:"../assets/food_chinese_takeout.png" },
    { id:"pizookie",      label:"Pizookie",         src:"../assets/food_cookie_pizza.png" },
    { id:"donut_stack",   label:"Donut Stack",      src:"../assets/food_donut_stack.png" },
    { id:"fried_chicken", label:"Fried Chicken",    src:"../assets/food_fried_chicken.png" },
    { id:"fries",         label:"Fries",            src:"../assets/food_fries.png" },
    { id:"grilledcheese", label:"Grilled Cheese",   src:"../assets/food_grilledcheese.png" },
    { id:"hotdogs",       label:"Hot Dogs",         src:"../assets/food_hotdogs.png" },
    { id:"icecream",      label:"Ice Cream",        src:"../assets/food_icecream_cone.png" },
    { id:"shake_choc",    label:"Chocolate Shake",  src:"../assets/food_milkshake_chocolate.png" },
    { id:"shake_straw",   label:"Strawberry Shake", src:"../assets/food_milkshake_strawberry.png" },
    { id:"shake_van",     label:"Vanilla Shake",    src:"../assets/food_milkshake_vanilla.png" },
    { id:"onion_rings",   label:"Onion Rings",      src:"../assets/food_onion_rings.png" },
    { id:"pancakes",      label:"Pancakes",         src:"../assets/food_pancakes.png" },
    { id:"pizza_stack",   label:"Pizza Stack",      src:"../assets/food_pizza_stack.png" },
    { id:"popcorn",       label:"Popcorn",          src:"../assets/food_popcorn.png" },
    { id:"soda",          label:"Soda",             src:"../assets/food_soda.png" },
    { id:"sub",           label:"Sub",              src:"../assets/food_sub.png" },
  ];

  // ---------- DOM ----------
  const stage = document.getElementById('stage');
  const itemsLayer = document.getElementById('itemsLayer');
  const targetNameEl = document.getElementById('targetName');
  const targetFoodImg = document.getElementById('targetFoodImg');
  const mouthTarget = document.getElementById('mouthTarget');
  const toast = document.getElementById('toast');
  const sceneImg = document.getElementById('sceneImg');

  const runScoreEl = document.getElementById('runScore');
  const bestScoreEl = document.getElementById('bestScore');
  const dailyBestEl = document.getElementById('dailyBest');
  const streakEl = document.getElementById('streak');
  const multEl = document.getElementById('mult');
  const dailyNowEl = document.getElementById('dailyNow');
  const resetInEl = document.getElementById('resetIn');

  const btnReset = document.getElementById('btnReset');
  const btnShare = document.getElementById('btnShare');
  const btnDebug = document.getElementById('btnDebug');

  // ---------- STATE ----------
  let debug = false;
  let runScore = 0;
  let streak = 0;
  let bestScore = 0;

  // Daily storage
  const LS_KEY = 'phat_snack_daily_v3';
  const LS_BEST = 'phat_snack_dailybest_v3';
  const LS_BEST_RUN = 'phat_snack_best_run_v3';

  function todayKey(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function loadDaily(){
    const k = todayKey();
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){
      const fresh = { day:k, count:0 };
      localStorage.setItem(LS_KEY, JSON.stringify(fresh));
      return fresh;
    }
    try{
      const obj = JSON.parse(raw);
      if(obj.day !== k){
        const fresh = { day:k, count:0 };
        localStorage.setItem(LS_KEY, JSON.stringify(fresh));
        return fresh;
      }
      return obj;
    }catch{
      const fresh = { day:k, count:0 };
      localStorage.setItem(LS_KEY, JSON.stringify(fresh));
      return fresh;
    }
  }

  function saveDailyCount(count){
    localStorage.setItem(LS_KEY, JSON.stringify({ day:todayKey(), count }));
  }

  function nextMidnightMs(){
    const now = new Date();
    const next = new Date(now);
    next.setHours(24,0,0,0);
    return next.getTime() - now.getTime();
  }

  function tickReset(){
    let ms = nextMidnightMs();
    if(ms < 0) ms = 0;
    const s = Math.floor(ms/1000);
    const hh = String(Math.floor(s/3600)).padStart(2,'0');
    const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    resetInEl.textContent = `${hh}:${mm}:${ss}`;
  }
  setInterval(tickReset, 250);
  tickReset();

  // ---------- GAME CONFIG ----------
  const items = [];

  // Pressure (but readable)
  const MAX_ONSCREEN = 5;
  const MIN_GAP = 150;        // more spacing = fewer mis-grabs
  let BASE_SPEED = 220;       // faster baseline so it feels alive
  let speedNow = BASE_SPEED;

  // Guarantee target appears quickly
  const TARGET_MAX_WAIT_MS = 7000; // force target within 7s
  let lastTargetSeenAt = Date.now();

  function rect(el){ return el.getBoundingClientRect(); }
  function stageDims(){
    const r = rect(stage);
    return { w:r.width, h:r.height, left:r.left, top:r.top };
  }

  function foodSizePx(){
    return (window.innerWidth >= 720) ? 92 : 88; // readable but not giant
  }

  // BELT LINE tuned for your stack_scene.png so food sits ON the belt
  function beltSurfaceY(){
    const { h } = stageDims();
    // This ratio puts food right on the belt top edge (based on your screenshot)
    return Math.round(h * 0.705);
  }

  function foodRideY(){
    const px = foodSizePx();
    // Pull food up onto belt surface (bigger value = higher on belt)
    return beltSurfaceY() - Math.round(px * 0.62);
  }

  function isInMouth(clientX, clientY){
    const m = rect(mouthTarget);
    return (clientX >= m.left && clientX <= m.right && clientY >= m.top && clientY <= m.bottom);
  }

  // ---------- TARGET ----------
  let target = null;
  function pickTarget(){
    target = FOODS[Math.floor(Math.random() * FOODS.length)];
    targetNameEl.textContent = target.label.toUpperCase();
    targetFoodImg.src = target.src;

    lastTargetSeenAt = Date.now();
  }

  function showToast(text, good){
    toast.textContent = text;
    toast.className = 'toast ' + (good ? 'good' : 'bad');
    toast.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.style.display = 'none', 650);
  }

  function updateHUD(){
    runScoreEl.textContent = runScore;
    bestScoreEl.textContent = bestScore;

    streakEl.textContent = streak;
    const mult = (1 + Math.min(0.8, streak * 0.05)).toFixed(1);
    multEl.textContent = mult + 'x';

    const d = loadDaily();
    dailyNowEl.textContent = d.count;

    const db = Number(localStorage.getItem(LS_BEST) || '0');
    dailyBestEl.textContent = db;
  }

  // ---------- SPAWN + MOVE ----------
  function spawnItem(x, forcedFood=null){
    const { w, h } = stageDims();
    if(!w || !h) return;

    const px = foodSizePx();
    const f = forcedFood || FOODS[Math.floor(Math.random()*FOODS.length)];

    const el = document.createElement('div');
    el.className = 'foodItem';
    el.style.width = px + 'px';
    el.style.height = px + 'px';

    const img = document.createElement('img');
    img.src = f.src;
    img.alt = f.label;
    el.appendChild(img);
    itemsLayer.appendChild(el);

    const obj = {
      food: f,
      el,
      x,
      y: foodRideY(),
      vx: -speedNow,
      dragging:false,
      pointerId:null,
      offX:0,
      offY:0
    };

    // If this is the target food, mark "seen"
    if(f.id === target.id){
      lastTargetSeenAt = Date.now();
    }

    // Drag (no jump)
    el.addEventListener('pointerdown', (ev) => {
      ev.preventDefault();
      el.setPointerCapture(ev.pointerId);
      obj.dragging = true;
      obj.pointerId = ev.pointerId;

      const er = rect(el);
      obj.offX = ev.clientX - er.left;
      obj.offY = ev.clientY - er.top;

      el.style.zIndex = 999;
    }, { passive:false });

    el.addEventListener('pointermove', (ev) => {
      if(!obj.dragging || obj.pointerId !== ev.pointerId) return;
      const sd = stageDims();
      const px = foodSizePx();

      obj.x = (ev.clientX - sd.left) - obj.offX;
      obj.y = (ev.clientY - sd.top) - obj.offY;

      obj.x = Math.max(-60, Math.min(sd.w - px + 60, obj.x));
      obj.y = Math.max(-60, Math.min(sd.h - px + 60, obj.y));
    });

    el.addEventListener('pointerup', (ev) => {
      if(!obj.dragging || obj.pointerId !== ev.pointerId) return;

      obj.dragging = false;
      obj.pointerId = null;
      el.style.zIndex = 7;

      const hit = isInMouth(ev.clientX, ev.clientY);
      if(hit){
        if(obj.food.id === target.id) onCorrect(obj);
        else onMiss(obj);
      } else {
        obj.y = foodRideY();
      }
    });

    el.addEventListener('pointercancel', () => {
      obj.dragging = false;
      obj.pointerId = null;
      el.style.zIndex = 7;
      obj.y = foodRideY();
    });

    items.push(obj);
  }

  function removeItem(obj){
    const idx = items.indexOf(obj);
    if(idx >= 0) items.splice(idx,1);
    obj.el.remove();
  }

  function topUp(){
    const sd = stageDims();
    const px = foodSizePx();
    if(!sd.w || !sd.h) return;

    const active = items.filter(it => it.x > -px*2).length;
    if(active >= MAX_ONSCREEN) return;

    let rightMost = -Infinity;
    for(const it of items) rightMost = Math.max(rightMost, it.x);
    let startX = (rightMost === -Infinity) ? (sd.w + px) : (rightMost + MIN_GAP);

    while(items.filter(it => it.x > -px*2).length < MAX_ONSCREEN){
      // TARGET INJECTION: if target hasn't appeared within the wait window, force it next
      const waited = Date.now() - lastTargetSeenAt;
      const mustInject = waited > TARGET_MAX_WAIT_MS;

      if(mustInject){
        spawnItem(startX, target);
      } else {
        // mild bias: 18% chance to spawn target naturally even before forcing
        const roll = Math.random();
        spawnItem(startX, roll < 0.18 ? target : null);
      }

      startX += MIN_GAP;
    }
  }

  function enforceSpacing(){
    const live = items.filter(it => !it.dragging).sort((a,b)=>a.x-b.x);
    for(let i=1;i<live.length;i++){
      const prev = live[i-1];
      const cur = live[i];
      if(cur.x - prev.x < MIN_GAP) cur.x = prev.x + MIN_GAP;
    }
  }

  // ---------- SCORING ----------
  function onCorrect(obj){
    runScore += 1;
    streak += 1;

    const mult = 1 + Math.min(0.75, streak * 0.05);
    speedNow = BASE_SPEED * mult;

    const d = loadDaily();
    d.count += 1;
    saveDailyCount(d.count);

    bestScore = Math.max(bestScore, runScore);
    localStorage.setItem(LS_BEST_RUN, String(bestScore));

    const dailyBest = Number(localStorage.getItem(LS_BEST) || '0');
    if(runScore > dailyBest) localStorage.setItem(LS_BEST, String(runScore));

    showToast('FED âœ…', true);
    removeItem(obj);
    pickTarget();
    updateHUD();
  }

  function onMiss(obj){
    streak = 0;
    speedNow = BASE_SPEED;

    showToast('MISSED âŒ', false);
    removeItem(obj);
    pickTarget();
    updateHUD();
  }

  // ---------- LOOP ----------
  let last = 0;
  function loop(ts){
    if(!last) last = ts;
    const dt = Math.min(0.033, (ts - last)/1000);
    last = ts;

    const sd = stageDims();
    const px = foodSizePx();

    if(sd.w && sd.h){
      for(const it of items){
        if(!it.dragging){
          it.vx = -speedNow;
          it.x += it.vx * dt;
          it.y = foodRideY();
        }
        it.el.style.transform = `translate3d(${Math.round(it.x)}px, ${Math.round(it.y)}px, 0)`;
      }

      for(let i=items.length-1;i>=0;i--){
        if(items[i].x < -px*3) removeItem(items[i]);
      }

      enforceSpacing();
      topUp();
    }

    requestAnimationFrame(loop);
  }

  function hardReset(){
    while(items.length) removeItem(items[0]);
    runScore = 0;
    streak = 0;
    speedNow = BASE_SPEED;

    bestScore = Number(localStorage.getItem(LS_BEST_RUN) || '0');

    pickTarget();
    updateHUD();

    requestAnimationFrame(() => topUp());
  }

  // ---------- Buttons ----------
  btnReset.addEventListener('click', hardReset);
  btnDebug.addEventListener('click', () => {
    debug = !debug;
    stage.classList.toggle('debugOn', debug);
  });

  btnShare.addEventListener('click', async () => {
    const d = loadDaily();
    const text = `$PHAT Conveyor Munch\nRun: ${runScore}\nStreak: ${streak}\nDaily: ${d.count}/30\nplanetfatness.fit/snack/`;
    try{
      if(navigator.share){
        await navigator.share({ text });
      } else {
        await navigator.clipboard.writeText(text);
        showToast('COPIED ðŸ“‹', true);
      }
    }catch{}
  });

  // ---------- INIT ----------
  function startWhenReady(){
    bestScore = Number(localStorage.getItem(LS_BEST_RUN) || '0');
    pickTarget();
    updateHUD();

    const tryStart = () => {
      const sd = stageDims();
      if(sd.w > 50 && sd.h > 50){
        topUp();
        requestAnimationFrame(loop);
      } else {
        requestAnimationFrame(tryStart);
      }
    };
    requestAnimationFrame(tryStart);
  }

  if(sceneImg && sceneImg.complete){
    startWhenReady();
  } else {
    sceneImg?.addEventListener('load', startWhenReady, { once:true });
    window.addEventListener('load', startWhenReady, { once:true });
  }

})();
</script>
</body>
</html>