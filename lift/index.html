<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>$PHAT ‚Äî Ego Lift Buffet</title>

<!-- ‚úÖ Shared UI -->
<link rel="stylesheet" href="/assets/pf-ui.css">
<script src="/assets/pf-ui.js" defer></script>

<style>
:root{
  --purple:#5b2cff;
  --yellow:#ffd400;
  --bg0:#07050c;
  --bg1:#0b0716;
  --panel:rgba(255,255,255,.08);
  --stroke:rgba(255,255,255,.14);
  --text:rgba(255,255,255,.95);
  --muted:rgba(255,255,255,.68);
  --good1:#7fff7f;
  --good2:#3bdc7a;
  --bad:#ff4d6d;

  --idleY: 0px;
  --idleScale: 1;
  --gifY: 0px;
  --gifScale: 1;

  --safe-bottom: env(safe-area-inset-bottom);
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(1100px 650px at 20% 10%, rgba(91,44,255,.35), transparent 55%),
    radial-gradient(900px 560px at 85% 20%, rgba(255,212,0,.22), transparent 60%),
    radial-gradient(900px 560px at 55% 120%, rgba(255,212,0,.10), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg0));
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}

/* ===== Shared page shell (scroll-safe) ===== */
.pf-wrap{
  min-height:100%;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding: 16px 0 calc(26px + var(--safe-bottom));
}
.pf-container{
  width:min(980px, 94vw);
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* keep toast fixed */
#toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  padding:10px 14px;
  border-radius:999px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(12px);
  color:rgba(255,255,255,.92);
  font-weight:1100;
  font-size:13px;
  display:none;
  z-index:50;
}

/* ===== Game stage ===== */
#stage{
  position:relative;
  width:100%;
  height:min(540px, 62vh);
  min-height:440px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow:0 30px 90px rgba(0,0,0,.55);
  overflow:hidden;

  /* IMPORTANT: allow accurate taps without scrolling/zooming */
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  user-select:none;
}

#vignette{
  position:absolute; inset:0;
  pointer-events:none;
  background:
    radial-gradient(circle at 50% 45%, rgba(0,0,0,0) 44%, rgba(0,0,0,.62) 84%, rgba(0,0,0,.86) 100%);
  opacity:.0;
  transition: opacity .12s ease;
}

#heroWrap{
  position:absolute;
  inset:0;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  pointer-events:none;
}

.heroStack{
  position:absolute;
  bottom:50px;
  left:50%;
  transform:translateX(-50%);
  height:460px;
  width:min(780px, 96%);
  display:flex;
  align-items:flex-end;
  justify-content:center;
  filter:drop-shadow(0 26px 42px rgba(0,0,0,.55));
  transform-origin:center bottom;
  will-change:transform;
}

.heroStack img{
  position:absolute;
  bottom:0;
  left:50%;
  transform:translateX(-50%);
  height:460px;
  width:auto;
  -webkit-user-drag:none;
}

#heroIdle{
  opacity:1;
  transform: translateX(-50%) translateY(var(--idleY)) scale(var(--idleScale));
}
#heroGif{
  opacity:0;
  transform: translateX(-50%) translateY(var(--gifY)) scale(var(--gifScale));
}

#meter{
  position:absolute;
  left:50%;
  bottom:22px;
  transform:translateX(-50%);
  width:72%;
  height:18px;
  border-radius:999px;
  background:rgba(255,255,255,.15);
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
}

#zone{
  position:absolute; top:0; height:100%;
  left:55%; width:18%;
  background:linear-gradient(180deg,var(--good1),var(--good2));
  opacity:.95;
  box-shadow:0 0 0 6px rgba(127,255,127,.10);
  transition: width .12s ease, left .12s ease;
}

#needle{
  position:absolute; top:0; height:100%;
  width:3px;
  left:0;
  background:#fff;
  box-shadow:0 0 16px rgba(255,255,255,.35);
}

#hud{
  position:absolute;
  top:16px;
  left:16px;
  display:flex;
  flex-direction:column;
  gap:8px;
  pointer-events:none;
}

.hudLine{
  display:inline-flex;
  gap:10px;
  align-items:baseline;
  padding:10px 12px;
  border-radius:16px;
  background:rgba(0,0,0,.28);
  border:1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(10px);
}

.big{ font-size:26px; font-weight:1200; letter-spacing:-.6px; }
.small{ font-size:12px; font-weight:1000; color:rgba(255,255,255,.70); }

#flash{
  position:absolute;
  left:50%;
  top:64px;
  transform:translateX(-50%) scale(.98);
  padding:10px 14px;
  border-radius:999px;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(10px);
  font-weight:1200;
  font-size:12px;
  letter-spacing:.5px;
  opacity:0;
  transition: opacity .10s ease, transform .10s ease;
  pointer-events:none;
}

/* ===== Daily row ===== */
.lift-dailyRow{
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.lift-pill{
  padding:10px 14px;
  border-radius:999px;
  background:var(--panel);
  border:1px solid var(--stroke);
  font-size:13px;
  font-weight:1000;
  color:var(--muted);
  backdrop-filter: blur(10px);
  user-select:none;
  white-space:nowrap;
}

/* ===== Modal ===== */
#modalBack{
  position:fixed; inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.65);
  backdrop-filter: blur(10px);
  z-index:60;
}

#modal{
  width:min(780px, calc(100% - 26px));
  border-radius:24px;
  border:1px solid rgba(255,255,255,.14);
  background:
    radial-gradient(900px 420px at 20% 0%, rgba(91,44,255,.32), transparent 60%),
    radial-gradient(900px 520px at 80% 80%, rgba(255,212,0,.16), transparent 65%),
    rgba(0,0,0,.55);
  box-shadow:0 40px 140px rgba(0,0,0,.75);
  padding:18px;
}

.grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media (max-width:720px){ .grid2{grid-template-columns:1fr;} }

.card{
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
  padding:14px;
}
.card .k{color:rgba(255,255,255,.70); font-weight:1100; font-size:12px}
.card .v{font-weight:1250; font-size:30px; letter-spacing:-.4px; margin-top:4px}
.card .s{color:rgba(255,255,255,.62); font-weight:1000; font-size:12px; margin-top:4px}

.actions{ display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; }
.sep{ height:1px; background:rgba(255,255,255,.10); margin:14px 0; }

.btn{
  padding:10px 16px;
  border-radius:14px;
  font-weight:1100;
  background:linear-gradient(180deg,var(--yellow),#ffbf00);
  color:#1b1400;
  border:none;
  box-shadow:0 14px 30px rgba(255,212,0,.45);
  cursor:pointer;
}
.btn:active{transform:scale(.98)}
.btn2{
  padding:10px 14px;
  border-radius:14px;
  font-weight:1100;
  background:rgba(0,0,0,.25);
  color:rgba(255,255,255,.92);
  border:1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(10px);
  cursor:pointer;
}
.btn2:active{transform:scale(.98)}
</style>
</head>

<body>
<div id="toast"></div>

<div class="pf-wrap">
  <div class="pf-container">

    <div class="pf-top">
      <div class="pf-title">
        <div class="pf-titleLine">$PHAT ‚Äî Ego Lift Buffet</div>
        <div class="pf-subLine">Tap once to wake up. Then release on green. Miss once = pinned.</div>
      </div>
      <div class="pf-chip" id="status">Tap once to wake up. Then release on green. Miss once = pinned.</div>
    </div>

    <div id="stage">
      <div id="hud">
        <div class="hudLine"><span class="big" id="repStreak">0</span><span class="small">rep streak</span></div>
        <div class="hudLine"><span class="big" id="runCals">0</span><span class="small">calories this run</span></div>
        <div class="hudLine"><span class="big" id="zonePct">18%</span><span class="small">green zone</span></div>
      </div>

      <div id="flash">CLEAN REP ‚úÖ</div>

      <div id="heroWrap">
        <div class="heroStack" id="heroStack">
          <img id="heroIdle" src="/assets/lift_idle.png" alt="Planet Fatness lifter idle"/>
          <img id="heroGif"  src="/assets/lift_hero.gif" alt="Planet Fatness lifter rep"/>
        </div>

        <div id="meter">
          <div id="zone"></div>
          <div id="needle"></div>
        </div>

        <div id="vignette"></div>
      </div>
    </div>

    <div class="lift-dailyRow">
      <div class="lift-pill">Today: <span id="todayCals">0</span> / <span id="cap">1000</span> calories</div>
      <div class="lift-pill">Resets in <span id="reset">--:--:--</span></div>
    </div>

    <div class="pf-bottom">
      <button class="pf-btn pf-primary" id="restartBtn">Run it back</button>
      <button class="pf-btn" id="pfShareBtn" data-pf-share="lift">Share score</button>
      <button class="pf-btn" id="backBtn">‚Üê Back to Gym</button>
    </div>

  </div>
</div>

<div id="modalBack">
  <div id="modal">
    <div class="row" style="width:100%; margin:0 0 10px">
      <div class="lift-pill" style="background:rgba(0,0,0,.25)">Run ended</div>
      <div class="lift-pill" id="endTag">Pinned by Pizza</div>
    </div>

    <div class="grid2">
      <div class="card">
        <div class="k">Best streak</div>
        <div class="v" id="mBest">0</div>
        <div class="s">how long you stayed blessed</div>
      </div>
      <div class="card">
        <div class="k">Smallest zone</div>
        <div class="v" id="mZone">18%</div>
        <div class="s">tiny green = legendary timing</div>
      </div>
      <div class="card">
        <div class="k">Calories earned</div>
        <div class="v" id="mRunCals">0</div>
        <div class="s">server-scored + capped (no farming)</div>
      </div>
      <div class="card">
        <div class="k">Today total</div>
        <div class="v" id="mToday">0</div>
        <div class="s">daily cap keeps it honest</div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="row" style="width:100%; justify-content:space-between; gap:10px; margin:0 0 10px">
      <div class="lift-pill" style="background:rgba(0,0,0,.25)">Share the flex</div>
      <div class="lift-pill" id="shareLine">Rep streak: 0 ‚Ä¢ Zone: 18% ‚Ä¢ Calories: 0</div>
    </div>

    <div class="actions">
      <button class="btn" id="againBtn">Run it back</button>
      <button class="btn2" id="shareBtn">Share</button>
      <button class="btn2" id="copyBtn">Copy</button>
      <button class="btn2" id="closeBtn">Close</button>
    </div>
  </div>
</div>

<script>
/* ========= ASSETS ========= */
const IDLE_SRC = "/assets/lift_idle.png";
const REP_SRC  = "/assets/lift_hero.gif";

/* ========= API + AUTH (matches your backend) ========= */
function readLS(k){ try{return (localStorage.getItem(k)||"").trim();}catch{return "";} }
const API_BASE = (window.PF_API_BASE) || readLS("pf_api_base") || readLS("phat_api_base") || "";
function getToken(){ return readLS("pf_token") || readLS("phat_token") || readLS("token"); }
function api(path){ const b=String(API_BASE||"").trim(); return b ? b.replace(/\/$/,"")+path : ""; }
function isLoggedIn(){ return !!(API_BASE && getToken()); }

async function fetchDailyProgress(){
  const token = getToken();
  if (!API_BASE || !token) return null;
  try{
    const r = await fetch(api("/daily/progress"), { headers:{ Authorization:"Bearer "+token } });
    const j = await r.json().catch(()=>null);
    return (j && j.games && j.games.lift) ? j : null;
  }catch{ return null; }
}

async function submitSecureLift({ score, durationMs }){
  const token = getToken();
  if (!API_BASE || !token) return null;
  try{
    const r = await fetch(api("/activity/submit"), {
      method:"POST",
      headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token },
      body: JSON.stringify({ game:"lift", score:Number(score||0), durationMs:Math.max(0, Math.floor(Number(durationMs||0))) })
    });
    const j = await r.json().catch(()=>null);
    return (j && j.ok) ? j : null;
  }catch{ return null; }
}

/* ========= DAILY FALLBACK (guest only) ========= */
let DAILY_CAP = 1000;
const KEY_RESET = "pf_daily_reset_at";
const KEY_TODAY = "pf_daily_today_cals";

function nextMidnight(){
  const d = new Date();
  return new Date(d.getFullYear(), d.getMonth(), d.getDate()+1).getTime();
}
let resetAt = Number(readLS(KEY_RESET) || nextMidnight());
let today = Number(readLS(KEY_TODAY) || 0);
if (Date.now() > resetAt){
  today = 0;
  resetAt = nextMidnight();
  try{ localStorage.setItem(KEY_RESET, String(resetAt)); localStorage.setItem(KEY_TODAY, String(today)); }catch{}
}

async function syncFromServer(){
  const prog = await fetchDailyProgress();
  if (!prog) return;
  const g = prog.games.lift;
  if (g?.caps?.dailyCapCalories != null) DAILY_CAP = Number(g.caps.dailyCapCalories || DAILY_CAP);
  if (g?.today?.calories != null) today = Number(g.today.calories || 0);
  try{ localStorage.setItem(KEY_TODAY, String(today)); }catch{}
}

/* ========= FAIR CALORIES (local preview only; server final) ========= */
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function roundInt(n){ return Math.max(0, Math.round(n)); }

function caloriesForRep(repIndex, zoneW, loopSeconds){
  const BASE_ZONE_W = 0.18;
  const BASE_LOOP = 1.85;

  const zoneHard = clamp((BASE_ZONE_W / Math.max(0.035, zoneW)) - 1, 0, 3.0);
  const speedHard = clamp((BASE_LOOP / Math.max(0.70, loopSeconds)) - 1, 0, 1.6);
  const skillBoost = 1 + (0.22 * zoneHard) + (0.18 * speedHard);

  let diminish = 1.0;
  if (repIndex >= 16) diminish = 0.70;
  if (repIndex >= 31) diminish = 0.45;
  if (repIndex >= 51) diminish = 0.30;

  const streakBonus = (repIndex % 5 === 0) ? 1 : 0;
  return roundInt((3.0 * skillBoost * diminish) + streakBonus);
}

/* ========= DIFFICULTY ========= */
const BASE_LOOP = 1.85;
const MIN_LOOP  = 0.85;
const BASE_ZONE_W = 0.18;
const MIN_ZONE_W  = 0.045;
const SHRINK_EARLY = 0.007;
const SHRINK_LATE  = 0.003;
const JITTER = 0.12;
const CENTER = 0.62;

/* ========= FEEL ========= */
const REP_HOLD_MS = 1250;
const COOLDOWN_MS = 90;
const FLASH_MS    = 320;

const el = (id)=>document.getElementById(id);

const stage = el("stage");
const heroStack = el("heroStack");
const heroIdle  = el("heroIdle");
const heroGif   = el("heroGif");

const zoneEl   = el("zone");
const needleEl = el("needle");
const vignette = el("vignette");

const repStreakEl = el("repStreak");
const runCalsEl   = el("runCals");
const zonePctEl   = el("zonePct");

const todayCalsEl = el("todayCals");
const capEl       = el("cap");
const resetEl     = el("reset");
const statusEl    = el("status");
const flashEl     = el("flash");
const toastEl     = el("toast");

const modalBack = el("modalBack");
const endTagEl  = el("endTag");
const mBestEl   = el("mBest");
const mZoneEl   = el("mZone");
const mRunCalsEl= el("mRunCals");
const mTodayEl  = el("mToday");
const shareLine = el("shareLine");

function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  clearTimeout(window.__t);
  window.__t = setTimeout(()=>toastEl.style.display="none", 2300);
}
function flash(msg){
  flashEl.textContent = msg;
  flashEl.style.opacity = 1;
  flashEl.style.transform = "translateX(-50%) scale(1)";
  setTimeout(()=>{
    flashEl.style.opacity = 0;
    flashEl.style.transform = "translateX(-50%) scale(.98)";
  }, FLASH_MS);
}

/* zone */
let loopSeconds = BASE_LOOP;
let zoneW = BASE_ZONE_W;
let zoneLeft = 0.54;
let smallestZone = BASE_ZONE_W;

function setZoneUI(){
  zoneW = Math.max(MIN_ZONE_W, Math.min(BASE_ZONE_W, zoneW));
  zoneLeft = Math.max(0, Math.min(1-zoneW, zoneLeft));
  zoneEl.style.width = (zoneW*100)+"%";
  zoneEl.style.left  = (zoneLeft*100)+"%";
  zonePctEl.textContent = Math.round(zoneW*100) + "%";
}
function rerollZone(){
  const center = CENTER + (Math.random()*2-1)*JITTER;
  zoneLeft = center - zoneW/2;
  setZoneUI();
}
function setDifficulty(reps){
  const shrink = reps <= 20 ? SHRINK_EARLY : SHRINK_LATE;
  zoneW = Math.max(MIN_ZONE_W, zoneW - shrink);
  const t = Math.min(1, reps/22);
  loopSeconds = Math.max(MIN_LOOP, BASE_LOOP - (BASE_LOOP - MIN_LOOP)*t);
  smallestZone = Math.min(smallestZone, zoneW);
  rerollZone();
}

/* rep anim (same as your working one) */
let repTimer=null, repSeq=0;
let lock=false;

function playRep(){
  if (lock || over) return;
  lock = true;

  heroIdle.style.opacity = 0;
  heroGif.style.opacity = 1;

  repSeq++;
  heroGif.src = REP_SRC + "?r=" + repSeq;

  clearTimeout(repTimer);
  repTimer = setTimeout(()=>{
    heroGif.style.opacity = 0;
    heroIdle.style.opacity = 1;
    repTimer = null;
    setTimeout(()=>{ lock=false; }, COOLDOWN_MS);
  }, REP_HOLD_MS);
}

/* state (same model) */
let running=false;
let over=false;
let start=performance.now();

let reps=0;
let bestReps=0;
let runCals=0;

/* modal */
function showModal(){ modalBack.style.display="flex"; }
function hideModal(){ modalBack.style.display="none"; }

function resetRun(){
  running=false; over=false; lock=false;
  reps=0; bestReps=0; runCals=0;
  loopSeconds=BASE_LOOP;
  zoneW=BASE_ZONE_W;
  smallestZone=zoneW;
  start=performance.now();

  repStreakEl.textContent="0";
  runCalsEl.textContent="0";
  vignette.style.opacity=0;
  statusEl.textContent="Tap once to wake up. Then release on green. Miss once = pinned.";
  hideModal();

  rerollZone();

  capEl.textContent = String(DAILY_CAP);
  todayCalsEl.textContent = String(today);

  syncFromServer().then(()=>{
    capEl.textContent = String(DAILY_CAP);
    todayCalsEl.textContent = String(today);
  });
}

async function endRun(reason){
  over = true;
  vignette.style.opacity = 1;

  const tags = ["Pinned by Pizza","Ego too heavy","Spotter went to vape","Elbows said ‚Äúnah‚Äù","Yoo-hoo fueled delusion"];
  endTagEl.textContent = reason || tags[(Math.random()*tags.length)|0];

  bestReps = Math.max(bestReps, reps);
  const durationMs = Math.max(0, Math.round(performance.now() - start));

  let res = null;
  if (isLoggedIn()){
    res = await submitSecureLift({ score: bestReps, durationMs });
    if (res && res.ok){
      runCals = Number(res.earnedCalories || 0);
      if (res.today && typeof res.today.calories === "number") today = Number(res.today.calories || 0);
      if (res.caps && typeof res.caps.dailyCapCalories === "number") DAILY_CAP = Number(res.caps.dailyCapCalories || DAILY_CAP);
      if (runCals === 0 && res.reason === "too_short") toast("Too short. No calories.");
      if (runCals === 0 && res.reason === "score_too_high") toast("Too fast. No calories.");
    } else {
      toast("Couldn‚Äôt sync run (server).");
    }
  } else {
    toast("Guest run. Connect via hub to stack lifetime calories.");
  }

  runCalsEl.textContent = String(runCals);
  todayCalsEl.textContent = String(today);
  capEl.textContent = String(DAILY_CAP);

  mBestEl.textContent = String(bestReps);
  mZoneEl.textContent = Math.round(smallestZone*100) + "%";
  mRunCalsEl.textContent = String(runCals);
  mTodayEl.textContent = String(today);

  const shareText =
    `$PHAT Ego Lift Buffet üü£\n` +
    `Rep streak: ${bestReps}\n` +
    `Smallest green zone: ${Math.round(smallestZone*100)}%\n` +
    `Calories: ${runCals} (today ${today}/${DAILY_CAP})\n` +
    `planetfatness.fit/lift`;

  shareLine.textContent = `Rep streak: ${bestReps} ‚Ä¢ Zone: ${Math.round(smallestZone*100)}% ‚Ä¢ Calories: ${runCals}`;
  window.__shareText = shareText;

  showModal();
}

/* ‚úÖ INPUT: keep your ‚Äúrelease-only‚Äù mechanic, but fix iOS double-fire.
   - start on first RELEASE (same as your working file)
   - evaluate only once per physical tap
   - bind to STAGE so releasing outside doesn‚Äôt cause weirdness
*/
let tapArmed = false;
let lastEvalTs = 0;

function armTap(){
  tapArmed = true;
}

function onRelease(e){
  // stop iOS from also generating a second synthetic event
  try{ e.preventDefault(); }catch{}

  const nowTs = Date.now();
  if (nowTs - lastEvalTs < 40) return; // double-fire guard
  lastEvalTs = nowTs;

  if (over) return;
  if (!tapArmed) return; // must have had a down inside stage
  tapArmed = false;

  if (!running){
    running = true;
    start = performance.now();
    statusEl.textContent = "Release on green. Miss once and you‚Äôre done.";
    const pre = new Image(); pre.src = REP_SRC;
    syncFromServer(); // doesn‚Äôt block
    return;
  }
  if (lock) return;

  const now = performance.now();
  const phase = (((now - start)/1000) % loopSeconds) / loopSeconds;

  const inGreen = (phase >= zoneLeft) && (phase <= zoneLeft + zoneW);

  if (inGreen){
    reps++;
    repStreakEl.textContent = String(reps);

    // guest preview only (server truth on end)
    const add = caloriesForRep(reps, zoneW, loopSeconds);
    if (!isLoggedIn()){
      if (today < DAILY_CAP && add > 0){
        const actualAdd = Math.min(add, DAILY_CAP - today);
        runCals += actualAdd;
        today += actualAdd;
        runCalsEl.textContent = String(runCals);
        todayCalsEl.textContent = String(today);
        try{ localStorage.setItem(KEY_TODAY, String(today)); }catch{}
      }
    }

    if (reps === 1) flash("CLEAN REP ‚úÖ");
    else if (reps % 5 === 0) flash(`CLEAN REP x${reps} ‚úÖ`);
    else flash("CLEAN ‚úÖ");

    setDifficulty(reps);
    playRep();
  } else {
    endRun();
  }
}

// pointer path
stage.addEventListener("pointerdown", (e)=>{ try{ e.preventDefault(); }catch{} armTap(); }, { passive:false });
stage.addEventListener("pointerup", onRelease, { passive:false });

// touch fallback (some iOS builds are flaky with pointer events)
stage.addEventListener("touchstart", (e)=>{ try{ e.preventDefault(); }catch{} armTap(); }, { passive:false });
stage.addEventListener("touchend", onRelease, { passive:false });

/* Buttons */
el("restartBtn").onclick = ()=> resetRun();
el("againBtn").onclick   = ()=> resetRun();
el("closeBtn").onclick   = ()=> hideModal();

const backBtn = el("backBtn");
backBtn.addEventListener("click", ()=>{ window.location.href = "../index.html#gym"; });

/* Share */
const pfShareBtn = el("pfShareBtn");
pfShareBtn.addEventListener("click", async ()=>{
  try{
    if (window.PF_UI && typeof window.PF_UI.share === "function"){ window.PF_UI.share({ game:"lift" }); return; }
    if (window.PFUI && typeof window.PFUI.share === "function"){ window.PFUI.share({ game:"lift" }); return; }
  }catch{}

  const text = window.__shareText || `$PHAT Ego Lift Buffet üü£\nplanetfatness.fit/lift`;
  if (navigator.share){ try{ await navigator.share({ text }); }catch{} return; }
  try{ await navigator.clipboard.writeText(text); toast("Copied. Paste it into X."); }catch{ toast("Screenshot + post."); }
});

el("copyBtn").onclick = async ()=>{
  try{ await navigator.clipboard.writeText(window.__shareText || ""); toast("Copied. Post the flex."); }
  catch{ toast("Couldn‚Äôt copy. Screenshot it."); }
};
el("shareBtn").onclick = async ()=>{
  const text = window.__shareText || "";
  if (navigator.share){ try{ await navigator.share({ text }); }catch{} return; }
  try{ await navigator.clipboard.writeText(text); toast("Copied. Paste it into X."); }catch{ toast("Screenshot + post."); }
};

/* Countdown */
function tick(){
  if (Date.now() > resetAt){
    today = 0;
    resetAt = nextMidnight();
    try{ localStorage.setItem(KEY_RESET, String(resetAt)); localStorage.setItem(KEY_TODAY, String(today)); }catch{}
  }
  const r = Math.max(0, resetAt - Date.now());
  const h = String(Math.floor(r/36e5)).padStart(2,'0');
  const m = String(Math.floor((r%36e5)/6e4)).padStart(2,'0');
  const s = String(Math.floor((r%6e4)/1e3)).padStart(2,'0');
  resetEl.textContent = `${h}:${m}:${s}`;
}
setInterval(tick,1000); tick();

/* Loop */
function loop(){
  const now = performance.now();
  if (!over){
    const phase = (((now - start)/1000) % loopSeconds) / loopSeconds;
    needleEl.style.left = (phase*100) + "%";
    const wob = Math.sin(now/160)*0.010 + Math.sin(now/520)*0.010;
    const scale = 1.02 + wob;
    heroStack.style.transform = `translateX(-50%) translateY(${Math.sin(now/220)*2}px) scale(${scale})`;
  }
  requestAnimationFrame(loop);
}

/* Init */
heroIdle.src = IDLE_SRC;
heroGif.src  = REP_SRC;

repStreakEl.textContent = "0";
runCalsEl.textContent = "0";

loopSeconds = BASE_LOOP;
zoneW = BASE_ZONE_W;
smallestZone = zoneW;
rerollZone();

capEl.textContent = String(DAILY_CAP);
todayCalsEl.textContent = String(today);

syncFromServer().then(()=>{
  capEl.textContent = String(DAILY_CAP);
  todayCalsEl.textContent = String(today);
});

requestAnimationFrame(loop);
</script>
</body>
</html>