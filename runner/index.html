<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>$PHAT â€” Treadmill Rage Runner</title>

  <style>
    :root {
      --purple:#5b2cff;
      --yellow:#ffd400;
      --bg:#0b0716;
      --panel:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.95);
      --muted:rgba(255,255,255,.65);
    }

    html,body{
      margin:0;
      height:100%;
      background:
        radial-gradient(900px 500px at 50% 0%, rgba(91,44,255,.35), transparent 60%),
        radial-gradient(700px 400px at 50% 100%, rgba(255,212,0,.25), transparent 60%),
        linear-gradient(180deg, #140b2b, #07050c);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      overflow:hidden;
    }

    #wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:14px;
    }

    .row{
      width:min(920px,100%);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .pill{
      padding:8px 14px;
      border-radius:999px;
      background:var(--panel);
      border:1px solid var(--stroke);
      font-size:13px;
      font-weight:800;
      color:var(--muted);
    }

    .btn{
      padding:10px 16px;
      border-radius:14px;
      font-weight:900;
      background:linear-gradient(180deg, var(--yellow), #ffbf00);
      color:#1b1400;
      border:none;
      box-shadow:0 14px 30px rgba(255,212,0,.45);
      cursor:pointer;
    }

    #stage{
      position:relative;
      width:min(920px,100%);
    }

    canvas{
      width:100%;
      border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      box-shadow:0 30px 90px rgba(0,0,0,.55);
      touch-action:manipulation;
      display:block;
    }

    /* Runner overlay */
    #runnerWrap{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }

    #runnerGif{
      height:320px;
      transform-origin:center bottom;
      filter: drop-shadow(0 30px 40px rgba(0,0,0,.55));
      margin-bottom:14px; /* âœ… BASE BELT ALIGNMENT */
      will-change: transform;
    }
  </style>
</head>

<body>
<div id="wrap">

  <div class="row">
    <div class="pill">$PHAT â€” Treadmill Rage Runner</div>
    <div class="pill" id="status">Tap to start</div>
    <button class="btn" onclick="resetGame()">Restart</button>
  </div>

  <div id="stage">
    <canvas id="c" width="900" height="520"></canvas>
    <div id="runnerWrap">
      <!-- MUST EXIST: /assets/runner.gif -->
      <img id="runnerGif" src="../assets/runner.gif" />
    </div>
  </div>

  <div class="row">
    <div class="pill">Controls: Tap / Click / Space</div>
    <div class="pill">Best: <span id="best">0.0s</span></div>
  </div>

</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
const bestEl = document.getElementById('best');
const gif = document.getElementById('runnerGif');

const BEST_KEY = 'phat_best';
let best = Number(localStorage.getItem(BEST_KEY)||0);
bestEl.textContent = best.toFixed(1)+'s';

let running=false, gameOver=false;
let t=0,last=performance.now();
let speed=.34, stamina=1, incline=0, required=.32;
let tapPulse=0, wobble=0, grace=1.2;

function resetGame(){
  running=false; gameOver=false;
  t=0; speed=.34; stamina=1; incline=0; required=.32;
  tapPulse=0; wobble=0; grace=1.2;
  last=performance.now();
  statusEl.textContent='Tap to start';
}

function tap(){
  if(gameOver){ resetGame(); running=true; return; }
  if(!running){ running=true; last=performance.now(); statusEl.textContent='RUN'; }
  tapPulse=Math.min(1.8,tapPulse+.18);
}

window.addEventListener('pointerdown',tap);
window.addEventListener('keydown',e=>{if(e.code==='Space')tap();});

function update(dt){
  if(!running)return;
  dt=Math.min(.02,dt);
  t+=dt;
  grace=Math.max(0,grace-dt);

  const ramp=1-Math.exp(-t/40);
  incline=.04+.85*ramp;
  required=.30+.55*ramp;

  tapPulse=Math.max(0,tapPulse-(.85+incline)*dt);
  const target=.22+.75*(tapPulse/1.2)*(0.6+0.4*stamina);
  speed+=(target-speed)*3*dt;
  speed=Math.max(0,speed-(.2+.55*incline)*dt);

  stamina=Math.max(0,stamina-(.05+.2*incline+.1*speed)*dt);
  if(tapPulse>.6)stamina=Math.min(1,stamina+.05*dt);

  if(grace<=0 && (speed<required||stamina<=0)){
    wobble+=dt*3;
    if(wobble>1){
      gameOver=true; running=false;
      statusEl.textContent='Flew off ðŸ’¥';
      if(t>best){best=t;localStorage.setItem(BEST_KEY,best);bestEl.textContent=best.toFixed(1)+'s';}
    }
  } else wobble=Math.max(0,wobble-dt*2);
}

function draw(){
  ctx.clearRect(0,0,900,520);

  ctx.fillStyle='rgba(255,255,255,.9)';
  ctx.font='800 28px system-ui';
  ctx.fillText(t.toFixed(1)+'s',40,46);

  // treadmill
  ctx.fillStyle='rgba(0,0,0,.45)';
  ctx.fillRect(160,380,580,60);

  // bars
  drawBar(40,450,380,22,speed,'Speed');
  drawBar(480,450,380,22,stamina,'Stamina');

  applyGifMotion();
}

function drawBar(x,y,w,h,p,label){
  ctx.fillStyle='rgba(255,255,255,.15)';
  ctx.fillRect(x,y,w,h);
  ctx.fillStyle=label==='Speed'?'#ffd400':'#7fff7f';
  ctx.fillRect(x,y,w*Math.max(0,Math.min(1,p)),h);
  ctx.fillStyle='rgba(0,0,0,.8)';
  ctx.font='700 12px system-ui';
  ctx.fillText(label,x+6,y+15);
}

function applyGifMotion(){
  const lean = -incline * 12;
  const scale = .95 + speed*.15;
  const yStick = 6 - incline*18;   // âœ… keeps feet glued to belt as incline rises
  const shake = wobble>0 ? Math.sin(performance.now()/60)*wobble*6 : 0;

  gif.style.transform =
    `translate(${shake}px, ${yStick}px) rotate(${lean}deg) scale(${scale})`;
}

function loop(now){
  const dt=(now-last)/1000; last=now;
  update(dt); draw();
  requestAnimationFrame(loop);
}

resetGame();
requestAnimationFrame(loop);
</script>
</body>
</html>