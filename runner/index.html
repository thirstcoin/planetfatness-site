<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>$PHAT ‚Äî Treadmill Run</title>

  <style>
    :root {
      --purple:#5b2cff;
      --yellow:#ffd400;
      --bg:#0b0716;
      --panel:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.95);
      --muted:rgba(255,255,255,.70);
    }

    html,body{
      margin:0;
      height:100%;
      background:
        radial-gradient(900px 500px at 50% 0%, rgba(91,44,255,.35), transparent 60%),
        radial-gradient(700px 400px at 50% 100%, rgba(255,212,0,.25), transparent 60%),
        linear-gradient(180deg, #140b2b, #07050c);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      overflow:hidden;
    }

    #wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:14px;
    }

    canvas{
      width:min(920px, 100%);
      border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      box-shadow:0 30px 90px rgba(0,0,0,.55);
      touch-action:manipulation;
    }

    .row{
      width:min(920px,100%);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .pill{
      padding:8px 14px;
      border-radius:999px;
      background:var(--panel);
      border:1px solid var(--stroke);
      font-size:13px;
      font-weight:800;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }

    .btn{
      padding:10px 16px;
      border-radius:14px;
      font-weight:950;
      background:linear-gradient(180deg, var(--yellow), #ffbf00);
      color:#1b1400;
      border:none;
      box-shadow:0 14px 30px rgba(255,212,0,.45);
      cursor:pointer;
    }
    .btn.secondary{
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(255,255,255,.92);
      box-shadow:0 18px 50px rgba(0,0,0,.35);
    }

    .btn:active{ transform:scale(.98); }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 10px 14px;
      color: rgba(255,255,255,.92);
      font-weight: 950;
      font-size: 13px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      display:none;
      z-index:50;
    }

    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--yellow);
      box-shadow: 0 0 0 6px rgba(255,212,0,.12);
      flex:0 0 auto;
    }

    .rightActions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }
  </style>
</head>

<body>
<div id="wrap">
  <div class="toast" id="toast"></div>

  <div class="row">
    <div class="pill"><span class="dot"></span>$PHAT ‚Äî Treadmill Runner</div>
    <div class="pill" id="status">Tap to start</div>

    <div class="rightActions">
      <button class="btn secondary" id="backBtn">‚Üê Site</button>
      <button class="btn secondary" id="connectBtn">üü£ Connect</button>
      <button class="btn" onclick="resetGame()">Restart</button>
    </div>
  </div>

  <div class="row">
    <div class="pill" id="walletPill">Wallet: ‚Äî</div>
    <div class="pill">Controls: Tap / Click / Space</div>
    <div class="pill">Best: <span id="best">0.0s</span></div>
  </div>

  <canvas id="c" width="900" height="520"></canvas>

  <div class="row">
    <div class="pill" id="serverPill">Server calories: connect wallet to save</div>
    <div class="pill" id="lastRunPill">Last run: ‚Äî</div>
  </div>
</div>

<script>
/**
 * ==========================
 * CONFIG (CHANGE THIS ONE)
 * ==========================
 */
const API_BASE = "https://YOUR-RENDER-BACKEND.onrender.com"; // <-- set this

/**
 * Session keys (shared with homepage)
 */
const TOKEN_KEY = "phat_token";
const ADDR_KEY  = "phat_address";

/**
 * Local best time (still useful even offline)
 */
const BEST_KEY = "phat_treadmill_best_seconds";

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
const bestEl = document.getElementById('best');
const walletPill = document.getElementById('walletPill');
const serverPill = document.getElementById('serverPill');
const lastRunPill = document.getElementById('lastRunPill');
const toastEl = document.getElementById('toast');

document.getElementById("backBtn").addEventListener("click", () => {
  window.location.href = "https://planetfatness.fit/";
});

document.getElementById("connectBtn").addEventListener("click", connectAndLogin);

function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(() => toastEl.style.display = "none", 2400);
}

function shortAddr(a){
  if (!a) return "‚Äî";
  return a.slice(0,4) + "‚Ä¶" + a.slice(-4);
}

function getToken(){ return localStorage.getItem(TOKEN_KEY) || ""; }
function getAddr(){ return localStorage.getItem(ADDR_KEY) || ""; }
function setSession(addr, token){
  localStorage.setItem(ADDR_KEY, addr);
  localStorage.setItem(TOKEN_KEY, token);
}

function setWalletUI(){
  const addr = getAddr();
  const token = getToken();
  walletPill.textContent = "Wallet: " + (addr ? shortAddr(addr) : "‚Äî");
  serverPill.textContent = token
    ? "Server calories: enabled ‚úÖ"
    : "Server calories: connect wallet to save";
}

let best = Number(localStorage.getItem(BEST_KEY) || 0);
bestEl.textContent = best.toFixed(1) + 's';

let running=false, gameOver=false;
let t=0, last=performance.now();
let speed=.35, stamina=1, incline=0, required=.35;
let tapPulse=0, wobble=0, legPhase=0;

// Track taps for backend stats (anti-cheat cadence)
let taps=0;

// Prevent double-submit on same game over
let submittedThisRun=false;

// Track max incline over the run for backend
let maxInclineSeen=0;

function resetGame(){
  running=false; gameOver=false;
  t=0; speed=.35; stamina=1; incline=0; required=.35;
  tapPulse=0; wobble=0; legPhase=0;
  taps=0;
  submittedThisRun=false;
  maxInclineSeen=0;

  statusEl.textContent='Tap to start';
  lastRunPill.textContent='Last run: ‚Äî';
}

function tap(){
  if(gameOver){
    resetGame();
    running=true;
    statusEl.textContent='RUN';
    return;
  }
  if(!running){
    running=true;
    statusEl.textContent='RUN';
  }
  tapPulse=Math.min(1.8, tapPulse+.18);
  taps++;
}

window.addEventListener('pointerdown', tap);
window.addEventListener('keydown', e=>{ if(e.code==='Space') tap(); });

function update(dt){
  if(!running) return;

  t+=dt;

  const ramp=1-Math.exp(-t/35);
  incline=.05+.85*ramp;
  required=.33+.55*ramp;

  // store max incline "percent-ish" for backend
  // (just scale to 0..12ish for now so it reads like a treadmill)
  const inclinePct = (incline * 12.5);
  if (inclinePct > maxInclineSeen) maxInclineSeen = inclinePct;

  tapPulse=Math.max(0, tapPulse-(.9+.9*incline)*dt);
  const target=.2+.7*(tapPulse/1.2)*(0.6+0.4*stamina);
  speed+= (target-speed)*3*dt;
  speed=Math.max(0, speed-(.22+.55*incline)*dt);

  stamina=Math.max(0, stamina-(.06+.22*incline+.1*speed)*dt);
  if(tapPulse>.6) stamina=Math.min(1, stamina+.04*dt);

  legPhase=(legPhase+dt*(1.5+5*speed))%1;

  if(speed<required-.02 || stamina<=0){
    wobble+=dt*3;
    if(wobble>1){
      triggerGameOver();
    }
  } else {
    wobble=Math.max(0, wobble-dt*2);
  }
}

function triggerGameOver(){
  if (gameOver) return;

  gameOver=true; running=false;
  statusEl.textContent='Flew off üí•';

  // Local best
  if(t>best){
    best=t;
    localStorage.setItem(BEST_KEY,best);
    bestEl.textContent=best.toFixed(1)+'s';
  }

  // UI for last run
  lastRunPill.textContent = `Last run: ${t.toFixed(1)}s ‚Ä¢ incline ${maxInclineSeen.toFixed(1)}% ‚Ä¢ taps ${taps}`;

  // Submit to server (once)
  if (!submittedThisRun) {
    submittedThisRun = true;
    submitRunToServer(t, maxInclineSeen, taps);
  }
}

async function submitRunToServer(seconds, maxIncline, taps){
  const token = getToken();
  const addr = getAddr();

  if (!token || !addr) {
    toast("Connect wallet to save calories + leaderboard.");
    return;
  }

  // idempotency
  const runId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random());

  try{
    const r = await fetch(API_BASE + "/activity/runner", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization":"Bearer " + token
      },
      body: JSON.stringify({
        runId,
        seconds: Number(seconds),
        maxIncline: Number(maxIncline),
        taps: Math.floor(Number(taps))
      })
    });

    const data = await r.json();
    if (!r.ok || data.error){
      toast(data.error || "Run submit failed.");
      return;
    }

    const earned = Number(data.caloriesEarned || 0);
    const total = String(data.totalCalories || "0");
    const bestSeconds = Number(data.bestSeconds || 0);

    toast(`+${earned.toLocaleString()} calories üî•`);
    serverPill.textContent = `Server calories: ${Number(total).toLocaleString()} ‚Ä¢ best ${bestSeconds.toFixed(1)}s`;

  } catch(e){
    console.error(e);
    toast("Backend unreachable. Run not saved.");
  }
}

/**
 * Optional: let runner also do login (same as homepage)
 * This keeps the runner standalone if someone lands here first.
 */
async function connectAndLogin(){
  const provider = window.solana;
  if (!provider?.isPhantom) {
    toast("Phantom not found. Install Phantom.");
    return;
  }

  try{
    const resp = await provider.connect();
    const address = resp.publicKey.toString();

    toast("Connected " + shortAddr(address) + " ‚Ä¢ sign to verify‚Ä¶");

    // challenge
    const ch = await fetch(API_BASE + "/auth/challenge", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ address })
    }).then(r => r.json());

    if (ch.error) { toast(ch.error); return; }

    // sign message
    const msgBytes = new TextEncoder().encode(ch.message);
    const signed = await provider.signMessage(msgBytes, "utf8");

    // signature as base64
    const sigB64 = btoa(String.fromCharCode(...signed.signature));

    // verify
    const v = await fetch(API_BASE + "/auth/verify", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ address, nonce: ch.nonce, signature: sigB64 })
    }).then(r => r.json());

    if (!v.token) {
      toast(v.error || "Verify failed");
      return;
    }

    setSession(address, v.token);
    setWalletUI();
    toast("Verified ‚úÖ " + shortAddr(address));

    // pull current totals for pill
    try{
      const me = await fetch(API_BASE + "/activity/me", {
        headers:{ "Authorization":"Bearer " + v.token }
      }).then(r => r.json());

      if (me?.totalCalories !== undefined){
        serverPill.textContent = `Server calories: ${Number(me.totalCalories).toLocaleString()} ‚Ä¢ best ${(Number(me.bestSeconds)||0).toFixed(1)}s`;
      } else {
        serverPill.textContent = "Server calories: enabled ‚úÖ";
      }
    } catch {}
  } catch(e){
    console.error(e);
    toast("Wallet connect/sign cancelled.");
  }
}

function draw(){
  ctx.clearRect(0,0,900,520);

  // time
  ctx.fillStyle='rgba(255,255,255,.9)';
  ctx.font='800 28px system-ui';
  ctx.fillText(t.toFixed(1)+'s', 40, 46);

  // treadmill
  ctx.fillStyle='rgba(0,0,0,.4)';
  ctx.fillRect(140,360,620,60);

  // runner body
  ctx.save();
  ctx.translate(320+wobble*8,300-wobble*15);

  ctx.fillStyle='rgba(255,255,255,.9)';
  ctx.beginPath();
  ctx.ellipse(160,10,90,70,0,0,Math.PI*2);
  ctx.fill();

  ctx.beginPath();
  ctx.ellipse(165,-80,50,46,0,0,Math.PI*2);
  ctx.fill();

  // heart glasses
  ctx.fillStyle='#ff4d6d';
  drawHeart(140,-90,14);
  drawHeart(188,-90,14);

  // legs
  drawLeg(140,70,Math.sin(legPhase*6.28));
  drawLeg(190,70,Math.sin(legPhase*6.28+Math.PI));

  ctx.restore();

  // bars
  drawBar(40,420,380,22,speed,'Speed');
  drawBar(480,420,380,22,stamina,'Stamina');

  // little hint when not connected
  if (!getToken()) {
    ctx.fillStyle='rgba(255,255,255,.65)';
    ctx.font='700 14px system-ui';
    ctx.fillText('Connect wallet to save calories + leaderboard', 40, 86);
  }
}

function drawBar(x,y,w,h,p,label){
  ctx.fillStyle='rgba(255,255,255,.15)';
  ctx.fillRect(x,y,w,h);
  ctx.fillStyle=label==='Speed'?'#ffd400':'#7fff7f';
  ctx.fillRect(x,y,w*Math.max(0,Math.min(1,p)),h);
  ctx.fillStyle='rgba(0,0,0,.8)';
  ctx.font='700 12px system-ui';
  ctx.fillText(label,x+6,y+15);
}

function drawLeg(x,y,p){
  ctx.strokeStyle='rgba(255,255,255,.9)';
  ctx.lineWidth=18;
  ctx.lineCap='round';
  ctx.beginPath();
  ctx.moveTo(x,y);
  ctx.lineTo(x+10+p*20,y+70-Math.max(0,p)*30);
  ctx.stroke();
}

function drawHeart(cx,cy,s){
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.bezierCurveTo(cx-s,cy-s,cx-2*s,cy+s*.4,cx,cy+2*s);
  ctx.bezierCurveTo(cx+2*s,cy+s*.4,cx+s,cy-s,cx,cy);
  ctx.fill();
}

function loop(now){
  const dt=Math.min(.05,(now-last)/1000);
  last=now;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

setWalletUI();
resetGame();
requestAnimationFrame(loop);
</script>
</body>
</html>
